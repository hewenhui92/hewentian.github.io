<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Tim Ho&#39;s Technology Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="my personal blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Tim Ho&#39;s Technology Blog">
<meta property="og:url" content="https://github.com/hewentian/page/3/index.html">
<meta property="og:site_name" content="Tim Ho&#39;s Technology Blog">
<meta property="og:description" content="my personal blog">
<meta property="og:locale" content="en-US">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tim Ho&#39;s Technology Blog">
<meta name="twitter:description" content="my personal blog">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Tim Ho&#39;s Technology Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">心如止水</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives/">Archives</a>
        
          <a class="main-nav-link" href="/categories/">Categories</a>
        
          <a class="main-nav-link" href="/tags/">Tags</a>
        
          <a class="main-nav-link" href="/about/">About</a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://github.com/hewentian"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-solr-cloud" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/03/solr-cloud/" class="article-date">
  <time datetime="2018-03-03T08:38:59.000Z" itemprop="datePublished">2018-03-03</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/03/solr-cloud/">solr 集群的创建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>solr 集群，即 solrcloud 的创建<br>下面说说solr集群的安装使用，同样是使用前面例子使用的 solr6.5.0 版本，我在一台机器上安装，所以这是伪集群，当修改为真集群的时候，只要将IP地址修改下即可，下面会说明。</p>
<p>首先，你得搭建 zookeeper 集群，可以参考 <a href="../../../../2017/12/06/zookeeper-install-cluster/">zookeeper集群版安装方法</a></p>
<h3 id="下面开始创建solr集群："><a href="#下面开始创建solr集群：" class="headerlink" title="下面开始创建solr集群："></a>下面开始创建solr集群：</h3><p>创建一个目录用于存放集群使用到的所有实例和配置信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD</span><br><span class="line">$ mkdir solrCloud		<span class="comment"># 存放集群的所有文件，包括：三个solr实例、和实例共享的配置文件solr-configs</span></span><br><span class="line">$ mkdir solrCloud/solr-configs	<span class="comment"># 用于存放集群的core的配置信息，会被上传到zookeeper</span></span><br></pre></td></tr></table></figure></p>
<p>将一个SOLR压缩包放到这个目录，我之前已在Downloads目录下载好了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cp /home/hewentian/Downloads/solr-6.5.0.tgz ./</span><br><span class="line">$ tar xzvf solr-6.5.0.tgz</span><br><span class="line">$ mv solr-6.5.0 solr1	<span class="comment"># 为方便起见，这里将其重命名为solr1，先将solr1配置好，后面会将其复制为solr2, solr3</span></span><br><span class="line"></span><br><span class="line">$ ls</span><br><span class="line">solr1  solr-6.5.0.tgz  solr-configs</span><br></pre></td></tr></table></figure></p>
<p>我们仍然使用之前的例子，演示使用DIH方式将数据导入到SOLR，只不过，这次是集群的方式，所以需要将<code>data_driven_schema_configs/conf</code>的配置信息复制到<code>solr-configs</code>中，并将其命名为<code>mysqlCore</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/home/hewentian/ProjectD/solrCloud</span><br><span class="line"></span><br><span class="line">$ cp -r solr1/server/solr/configsets/data_driven_schema_configs/conf/ solr-configs/mysqlCore/</span><br></pre></td></tr></table></figure></p>
<p>将mysql-connector-java-5.1.25.jar放到<code>solr1/server/lib/ext</code>目录下面，并将上一个例子，<a href="../../../../2017/10/28/solr-install/">solr的安装使用</a>的那三个文件: solrconfig.xml、db-data-config.xml、managed-schema复制到<code>solr-configs/mysqlCore/</code>下，override存在的。</p>
<p>接下来还有2个文件需要修改：<br>修改文件一：solr.in.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vi solr1/bin/solr.in.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改以下内容即可</span></span><br><span class="line">ZK_HOST=<span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183"</span></span><br><span class="line">ZK_CLIENT_TIMEOUT=<span class="string">"15000"</span></span><br><span class="line">SOLR_PORT=8983</span><br></pre></td></tr></table></figure></p>
<p>修改文件二：solr.xml<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vi solr1/server/solr/solr.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改下面的内容即可</span></span><br><span class="line">&lt;str name=<span class="string">"host"</span>&gt;<span class="variable">$&#123;host:127.0.0.1&#125;</span>&lt;/str&gt;   	<span class="comment"># 当修改为真集群的时候，只修改这个IP地址即可</span></span><br><span class="line">&lt;int name=<span class="string">"hostPort"</span>&gt;<span class="variable">$&#123;jetty.port:8983&#125;</span>&lt;/int&gt;	<span class="comment"># 这里端口为 8983</span></span><br></pre></td></tr></table></figure></p>
<p>这样一个实例就配置好了，将其复制为solr2, solr3<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp -r solr1 solr2</span><br><span class="line">$ cp -r solr1 solr3</span><br></pre></td></tr></table></figure></p>
<p>修改solr2, solr3的端口为8984, 8985<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ vi solr2/bin/solr.in.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改以下内容即可</span></span><br><span class="line">SOLR_PORT=8984</span><br><span class="line"></span><br><span class="line">$ vi solr3/bin/solr.in.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改以下内容即可</span></span><br><span class="line">SOLR_PORT=8985</span><br><span class="line"></span><br><span class="line">$ vi solr2/server/solr/solr.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改下面的内容即可</span></span><br><span class="line">&lt;str name=<span class="string">"host"</span>&gt;<span class="variable">$&#123;host:127.0.0.1&#125;</span>&lt;/str&gt;   	<span class="comment"># 当修改为真集群的时候，只修改这个IP地址即可</span></span><br><span class="line">&lt;int name=<span class="string">"hostPort"</span>&gt;<span class="variable">$&#123;jetty.port:8984&#125;</span>&lt;/int&gt;	<span class="comment"># 这里端口为 8984</span></span><br><span class="line"></span><br><span class="line">$ vi solr3/server/solr/solr.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改下面的内容即可</span></span><br><span class="line">&lt;str name=<span class="string">"host"</span>&gt;<span class="variable">$&#123;host:127.0.0.1&#125;</span>&lt;/str&gt;   	<span class="comment"># 当修改为真集群的时候，只修改这个IP地址即可</span></span><br><span class="line">&lt;int name=<span class="string">"hostPort"</span>&gt;<span class="variable">$&#123;jetty.port:8985&#125;</span>&lt;/int&gt;	<span class="comment"># 这里端口为 8985</span></span><br></pre></td></tr></table></figure></p>
<p>这样，三个solr实例就已经配置好了，下面将其都启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">pwd</span></span><br><span class="line">/home/hewentian/ProjectD/solrCloud</span><br><span class="line"></span><br><span class="line">$ solr1/bin/solr start</span><br><span class="line">Waiting up to 180 seconds to see Solr running on port 8983 [\]  </span><br><span class="line">Started Solr server on port 8983 (pid=15292). Happy searching!</span><br><span class="line"></span><br><span class="line">$ solr2/bin/solr start</span><br><span class="line">Waiting up to 180 seconds to see Solr running on port 8984 [\]  </span><br><span class="line">Started Solr server on port 8984 (pid=15507). Happy searching!</span><br><span class="line"></span><br><span class="line">$ solr3/bin/solr start</span><br><span class="line">Waiting up to 180 seconds to see Solr running on port 8985 [\]  </span><br><span class="line">Started Solr server on port 8985 (pid=15706). Happy searching!</span><br></pre></td></tr></table></figure></p>
<p>在浏览器中可以如下访问：<br><a href="http://localhost:8983" target="_blank" rel="noopener">http://localhost:8983</a><br><a href="http://localhost:8984" target="_blank" rel="noopener">http://localhost:8984</a><br><a href="http://localhost:8985" target="_blank" rel="noopener">http://localhost:8985</a></p>
<p>下面，我们将<code>solr-configs/mysqlCore</code>的内容上传到zookeeper，以便让三台solr都使用这个配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /home/hewentian/ProjectD/solrCloud/solr1/server/scripts/cloud-scripts/zkcli.sh -zkhost 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183 -cmd upconfig -confdir /home/hewentian/ProjectD/solrCloud/solr-configs/mysqlCore -confname mysqlCore</span><br></pre></td></tr></table></figure></p>
<h4 id="说明："><a href="#说明：" class="headerlink" title="说明："></a>说明：</h4><ol>
<li>-confdir：这个指的是 本地上传的文件位置    </li>
<li>-confname：上传后在zookeeper中的节点名称</li>
</ol>
<p>也可以上传单个文件，单个文件上传先要删除，不然会报错：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /home/hewentian/ProjectD/solrCloud/solr1/server/scripts/cloud-scripts/zkcli.sh -zkhost 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183 -cmd putfile /configs/mysqlCore/solrconfig.xml /home/hewentian/ProjectD/solrCloud/solr-configs/mysqlCore/solrconfig.xml</span><br></pre></td></tr></table></figure></p>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明:"></a>说明:</h4><p>putfile 后第一个<code>/configs/mysqlCore/solrconfig.xml</code>指的是<code>zookeeper</code>中的配置文件，第二个<code>/home/hewentian/ProjectD/solrCloud/solr-configs/mysqlCore/solrconfig.xml</code>指的是本地文件路径</p>
<p>下面我们在solr1中创建一个core，并命名为 mysqlCore，在浏览器中输入如下url即可，它有3个分片，每个分片有2个副本：<br><a href="http://localhost:8983/solr/admin/collections?action=CREATE&amp;name=mysqlCore&amp;numShards=3&amp;replicationFactor=2&amp;maxShardsPerNode=3&amp;collection.configName=mysqlCore" target="_blank" rel="noopener">http://localhost:8983/solr/admin/collections?action=CREATE&amp;name=mysqlCore&amp;numShards=3&amp;replicationFactor=2&amp;maxShardsPerNode=3&amp;collection.configName=mysqlCore</a><br>执行成功后，你可能会看到如下输出：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">This XML file does not appear to have any style information associated with it. The document tree is shown below.</span><br><span class="line"><span class="tag">&lt;<span class="name">response</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>16020<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"success"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8983_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>13930<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard3_replica2<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8983_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>14273<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard2_replica1<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8984_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>14479<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard3_replica1<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8985_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>14597<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard2_replica2<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8985_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>14748<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard1_replica1<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"127.0.0.1:8984_solr"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">lst</span> <span class="attr">name</span>=<span class="string">"responseHeader"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"status"</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span> <span class="attr">name</span>=<span class="string">"QTime"</span>&gt;</span>14778<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">str</span> <span class="attr">name</span>=<span class="string">"core"</span>&gt;</span>mysqlCore_shard1_replica2<span class="tag">&lt;/<span class="name">str</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">lst</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">response</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>也可以使用下面的方式，指定在哪台机器中创建哪个分片的哪个副本。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ curl <span class="string">"http://localhost:8983/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard1_replica1&amp;instanceDir=mysqlCore_shard1_replica1&amp;collection=mysqlCore&amp;shard=mysqlCore_shard1"</span></span><br><span class="line"></span><br><span class="line">$ curl <span class="string">"http://localhost:8983/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard3_replica2&amp;instanceDir=mysqlCore_shard3_replica2&amp;collection=mysqlCore&amp;shard=mysqlCore_shard3"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ curl <span class="string">"http://localhost:8984/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard1_replica2&amp;instanceDir=mysqlCore_shard1_replica2&amp;collection=mysqlCore&amp;shard=mysqlCore_shard1"</span></span><br><span class="line"></span><br><span class="line">$ curl <span class="string">"http://localhost:8984/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard2_replica1&amp;instanceDir=mysqlCore_shard2_replica1&amp;collection=mysqlCore&amp;shard=mysqlCore_shard2"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ curl <span class="string">"http://localhost:8985/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard2_replica2&amp;instanceDir=mysqlCore_shard2_replica2&amp;collection=mysqlCore&amp;shard=mysqlCore_shard2"</span></span><br><span class="line"></span><br><span class="line">$ curl <span class="string">"http://localhost:8985/solr/admin/cores?action=CREATE&amp;name=mysqlCore_shard3_replica1&amp;instanceDir=mysqlCore_shard3_replica1&amp;collection=mysqlCore&amp;shard=mysqlCore_shard3"</span></span><br></pre></td></tr></table></figure></p>
<p>你也可以查看分片是否创建成功：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ls solr1/server/solr</span><br><span class="line">configsets  mysqlCore_shard2_replica1  mysqlCore_shard3_replica2  README.txt  solr.xml  zoo.cfg</span><br><span class="line"></span><br><span class="line">$ ls solr2/server/solr</span><br><span class="line">configsets  mysqlCore_shard1_replica2  mysqlCore_shard3_replica1  README.txt  solr.xml  zoo.cfg</span><br><span class="line"></span><br><span class="line">$ ls solr3/server/solr</span><br><span class="line">configsets  mysqlCore_shard1_replica1  mysqlCore_shard2_replica2  README.txt  solr.xml  zoo.cfg</span><br></pre></td></tr></table></figure></p>
<p>在<a href="http://localhost:8983" target="_blank" rel="noopener">http://localhost:8983</a>上面执行DIH将user索引进solr，成功之后你就可以在<a href="http://localhost:8984" target="_blank" rel="noopener">http://localhost:8984</a>, <a href="http://localhost:8985" target="_blank" rel="noopener">http://localhost:8985</a>上面看到同样的结果。</p>
<p>当然，我们也可以在启动的时候，才指定zookeeper<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./bin/solr start -c -z zk1:port,zk2:port,zk3:port</span><br></pre></td></tr></table></figure></p>
<p>说明：</p>
<ol>
<li>-c：以solr_cloud的方式启动；</li>
<li>-z:指定zookeeper集群的地址和端口，上面搭建zookeeper集群时的3台机器</li>
</ol>
<h3 id="solr备份"><a href="#solr备份" class="headerlink" title="solr备份"></a>solr备份</h3><p>在进行solr备份的时候，一定要先将solr服务停了，然后再备份。否则在还原的时候有可能会产生<code>write.lock</code>，在产生<code>write.lock</code>的时候也不要怕，你可以按下面的方法解决：</p>
<ol>
<li><p>将<code>write.lock</code>删掉，然后再新建一个，然后修改权限；</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ rm write.lock</span><br><span class="line">$ touch write.lock</span><br><span class="line">$ chmod 666 write.lock</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启solr服务；</p>
</li>
<li>在浏览器登录到那个solr的cord，reload一下，然后查询，如果没报错的话，可能要等5分钟左右，查询结果就出来了。<br>[solr界面]-&gt;[collections]-&gt;[点击你的那个 collection]-&gt;[Reload]</li>
</ol>
<p>JAVA示例代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CloudSolrClient cloudSolrClient = <span class="keyword">new</span> CloudSolrClient.Builder()</span><br><span class="line">				.withZkHost(<span class="string">"127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183"</span>).build();</span><br><span class="line">		cloudSolrClient.setDefaultCollection(<span class="string">"mysqlCore"</span>);</span><br><span class="line"></span><br><span class="line">		SolrQuery solrQuery = <span class="keyword">new</span> SolrQuery();</span><br><span class="line"></span><br><span class="line">		solrQuery.setQuery(<span class="string">"schools:\"北京第一中学\" AND id:[1 TO 3]"</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 分页</span></span><br><span class="line">		solrQuery.setStart(<span class="number">0</span>);</span><br><span class="line">		solrQuery.setRows(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">		SolrDocumentList results = cloudSolrClient.query(solrQuery).getResults();</span><br><span class="line"></span><br><span class="line">		logger.info(<span class="string">"numFound: "</span> + results.getNumFound());</span><br><span class="line">		<span class="keyword">if</span> (CollectionUtils.isEmpty(results)) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		results.stream().forEach(logger::info);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>未完，待续……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/03/03/solr-cloud/" data-id="cjym9uqck00305w3ksdppfy8g" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solr/">solr</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-neo4j-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/02/17/neo4j-note/" class="article-date">
  <time datetime="2018-02-17T01:59:18.000Z" itemprop="datePublished">2018-02-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/db/">db</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/02/17/neo4j-note/">neo4j学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一些基本概念，从官网copy过来的，如下："><a href="#一些基本概念，从官网copy过来的，如下：" class="headerlink" title="一些基本概念，从官网copy过来的，如下："></a>一些基本概念，从官网copy过来的，如下：</h2><h3 id="Graph-Fundamentals"><a href="#Graph-Fundamentals" class="headerlink" title="Graph Fundamentals"></a>Graph Fundamentals</h3><p>Basic concepts to get you going.</p>
<p>A graph database can store any kind of data using a few simple concepts:</p>
<ol>
<li>Nodes - graph data records</li>
<li>Relationships - connect nodes</li>
<li>Properties - named data values</li>
</ol>
<h3 id="A-Graph-Database"><a href="#A-Graph-Database" class="headerlink" title="A Graph Database"></a>A Graph Database</h3><p>Neo4j stores data in a Graph, with records called Nodes.</p>
<p>The simplest graph has just a single node with some named values called Properties. Let’s draw a social graph of our friends on the Neo4j team:</p>
<ol>
<li>Start by drawing a circle for the node</li>
<li>Add the name Emil</li>
<li>Note that he is from Sweden</li>
</ol>
<ul>
<li>Nodes are the name for data records in a graph</li>
<li>Data is stored as Properties</li>
<li>Properties are simple name/value pairs</li>
</ul>
<h3 id="Labels"><a href="#Labels" class="headerlink" title="Labels"></a>Labels</h3><p>Associate a set of nodes.</p>
<p>Nodes can be grouped together by applying a Label to each member. In our social graph, we’ll label each node that represents a Person.</p>
<ol>
<li>Apply the label “Person” to the node we created for Emil</li>
<li>Color “Person” nodes red</li>
</ol>
<ul>
<li>A node can have zero or more labels</li>
<li>Labels do not have any properties</li>
</ul>
<h3 id="More-Nodes"><a href="#More-Nodes" class="headerlink" title="More Nodes"></a>More Nodes</h3><p>Schema-free, nodes can have a mix of common and unique properties.</p>
<p>Like any database, storing data in Neo4j can be as simple as adding more records. We’ll add a few more nodes:</p>
<ol>
<li>Emil has a klout score of 99</li>
<li>Johan, from Sweden, who is learning to surf</li>
<li>Ian, from England, who is an author</li>
<li>Rik, from Belgium, has a cat named Orval</li>
<li>Allison, from California, who surfs</li>
</ol>
<ul>
<li>Similar nodes can have different properties</li>
<li>Properties can be strings, numbers, or booleans</li>
<li>Neo4j can store billions of nodes</li>
</ul>
<h3 id="Consider-Relationships"><a href="#Consider-Relationships" class="headerlink" title="Consider Relationships"></a>Consider Relationships</h3><p>Connect nodes in the graph</p>
<p>The real power of Neo4j is in connected data. To associate any two nodes, add a Relationship which describes how the records are related.</p>
<p>In our social graph, we simply say who KNOWS whom:</p>
<ol>
<li>Emil KNOWS Johan and Ian</li>
<li>Johan KNOWS Ian and Rik</li>
<li>Rik and Ian KNOWS Allison</li>
</ol>
<ul>
<li>Relationships always have direction</li>
<li>Relationships always have a type</li>
<li>Relationships form patterns of data</li>
</ul>
<h3 id="Relationship-properties"><a href="#Relationship-properties" class="headerlink" title="Relationship properties"></a>Relationship properties</h3><p>Store information shared by two nodes.</p>
<p>In a property graph, relationships are data records that can also contain properties. Looking more closely at Emil’s relationships, note that:</p>
<ul>
<li>Emil has known Johan since 2001</li>
<li>Emil rates Ian 5 (out of 5)</li>
<li>Everyone else can have similar relationship properties</li>
</ul>
<p>可以使用这种方式访问neo4j数据库：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:7474/browser/</span><br></pre></td></tr></table></figure></p>
<h3 id="清空neo4j数据库"><a href="#清空neo4j数据库" class="headerlink" title="清空neo4j数据库"></a>清空neo4j数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">match(n)</span><br><span class="line">optional match(n)-[r]-()</span><br><span class="line">delete n,r</span><br></pre></td></tr></table></figure>
<p>执行上面的命令后，会删除节点及与该节点相关的关系，但是property keys删不干净</p>
<p>未完，待续……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/02/17/neo4j-note/" data-id="cjym9uqcc002c5w3k4uqpgw6y" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/neo4j/">neo4j</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-gitbook-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/29/gitbook-note/" class="article-date">
  <time datetime="2018-01-29T05:59:48.000Z" itemprop="datePublished">2018-01-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/other/">other</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/29/gitbook-note/">gitbook学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>下面说下如何安装gitbook</p>
<h3 id="1-安装-Node-js"><a href="#1-安装-Node-js" class="headerlink" title="1. 安装 Node.js"></a>1. 安装 Node.js</h3><p>先测试一下Node.js是否已安装，在命令行中直接输入<code>node</code>可以看到提示符变成了一个向右<br>的箭头就表示成功了，然后按ctrl + c退出node模式，出现$符号才表示正常了</p>
<p>如果未安裝 node，安裝方法如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install nodejs-legacy</span><br></pre></td></tr></table></figure></p>
<p>剩下的安装过程参考<a href="https://yq.aliyun.com/articles/7506" target="_blank" rel="noopener">https://yq.aliyun.com/articles/7506</a>，但是会有一些不同，如下所示：</p>
<h3 id="2-安装gitbook"><a href="#2-安装gitbook" class="headerlink" title="2. 安装gitbook"></a>2. 安装gitbook</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo npm install -g gitbook-cli</span><br></pre></td></tr></table></figure>
<h3 id="3-初始化"><a href="#3-初始化" class="headerlink" title="3. 初始化"></a>3. 初始化</h3><p>在你的文档目录下新建文件 SUMMARY.md，这个文件就是这本书的目录啦：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> docs</span><br><span class="line">$ touch SUMMARY.md</span><br></pre></td></tr></table></figure></p>
<p>SUMMARY.md 的格式规范如下：</p>
<pre><code># uitest 文档

- [uitest 是什么](users/index.md)
    - [如何使用 uitest](users/use.md)
    - [如何编写自定义的测试用例](users/case.md)
    - [browserjs API 文档](users/api.md)
- [uitest 开发者文档](devs/index.md)
    - [browserjs 开发者文档](devs/browserjs.md)
    - [utci 文档](devs/utci.md)
    - [utserver &amp; utclient 文档](devs/utserver.md)
- [相关文章沉淀](artical.md)
- [关于 gitbook](gitbook.md)
</code></pre><p>然后执行<code>gitbook init</code>初始化，gitbook 会根据 SUMMARY 的结构生成对应的目录文件：</p>
<pre><code>├── README.md           // 首页
├── SUMMARY.md          // 目录
└── users               // 用户文档
    └── index.md        // 是什么
    ├── use.md          // 如何使用
    ├── api.md          // browserjs API
    ├── case.md         // 如何写测试用例
├── devs                // 开发者文档目录
    │   ├── index.md        // 开发者文文档首页
    │   ├── browserjs.md    // browserjs 开发文档
    │   ├── utci.md         // utci 开发文档
    │   └── utserver.md     // utserver 和 utclien 开发文档
├── artical.md          // 文章沉淀
├── gitbook.md          // gitbook 相关
</code></pre><h3 id="4-本地调试"><a href="#4-本地调试" class="headerlink" title="4. 本地调试"></a>4. 本地调试</h3><p>在对应的文档目录下运行<code>gitbook serve</code>会启动一个本地的静态服务器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> docs</span><br><span class="line">$ gitbook serve</span><br><span class="line"></span><br><span class="line">Live reload server started on port: 35729</span><br><span class="line">Press CTRL+C to quit ...</span><br><span class="line"></span><br><span class="line">info: 7 plugins are installed </span><br><span class="line">info: loading plugin <span class="string">"livereload"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"highlight"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"search"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"lunr"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"sharing"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"fontsettings"</span>... OK </span><br><span class="line">info: loading plugin <span class="string">"theme-default"</span>... OK </span><br><span class="line">info: found 27 pages </span><br><span class="line">info: found 2 asset files</span><br></pre></td></tr></table></figure></p>
<p>访问 <a href="http://localhost:4000/" target="_blank" rel="noopener">http://localhost:4000/</a> 就可以实时的预览啦，并且支持<code>livereload</code>, 灰常赞~接下来结合预览的功能编辑对应的文档，完成之后就可以发布啦。</p>
<h3 id="5-发布"><a href="#5-发布" class="headerlink" title="5. 发布"></a>5. 发布</h3><p>在文档目录下执行<code>gitbook build</code>会生成一个<code>_book</code>的目录，这个目录就是我们的静态网站啦，然后通过 demo 平台或者 github pages 就可以很简单的完成部署了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/01/29/gitbook-note/" data-id="cjym9uqbr000l5w3kialytplv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-activemq-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/23/activemq-note/" class="article-date">
  <time datetime="2018-01-23T12:46:34.000Z" itemprop="datePublished">2018-01-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/23/activemq-note/">activeMQ学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Installation-Procedure-for-Unix"><a href="#Installation-Procedure-for-Unix" class="headerlink" title="Installation Procedure for Unix"></a>Installation Procedure for Unix</h3><p>Unix Binary Installation<br>This procedure explains how to download and install the binary distribution on a Unix system.<br><strong>NOTE</strong>: There are several alternative ways to perform this type of installation.</p>
<ol>
<li><p>Download the activemq zipped tarball file to the Unix machine, using either a browser or a tool, i.e., wget, scp, ftp, etc. for example:<br>(see <a href="http://activemq.apache.org/download.html" target="_blank" rel="noopener">Download</a> -&gt; “The latest stable release”)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://activemq.apache.org/path/tofile/apache-activemq-x.x.x-bin.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>Extract the files from the zipped tarball into a directory of your choice. For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> [activemq_install_dir]</span><br><span class="line">$ tar zxvf activemq-x.x.x-bin.tar.gz</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Starting-ActiveMQ"><a href="#Starting-ActiveMQ" class="headerlink" title="Starting ActiveMQ"></a>Starting ActiveMQ</h3><p>On Unix:<br>From a command shell, change to the installation directory and run ActiveMQ as a foregroud process:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> [activemq_install_dir]/bin</span><br><span class="line">$ ./activemq console</span><br></pre></td></tr></table></figure></p>
<p>From a command shell, change to the installation directory and run ActiveMQ as a daemon process:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> [activemq_install_dir]/bin</span><br><span class="line">$ ./activemq start</span><br></pre></td></tr></table></figure></p>
<h3 id="Stopping-ActiveMQ"><a href="#Stopping-ActiveMQ" class="headerlink" title="Stopping ActiveMQ"></a>Stopping ActiveMQ</h3><p>For both Windows and Unix installations, terminate ActiveMQ by typing “CTRL-C” in the console or command shell in which it is running.<br>If ActiveMQ was started in the background on Unix, the process can be killed, with the following:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> [activemq_install_dir]/bin</span><br><span class="line">$ ./activemq stop</span><br></pre></td></tr></table></figure></p>
<h3 id="Testing-the-Installation"><a href="#Testing-the-Installation" class="headerlink" title="Testing the Installation"></a>Testing the Installation</h3><p>Using the administrative interface</p>
<ul>
<li>Open the administrative interface</li>
<li>URL: <a href="http://127.0.0.1:8161/admin/" target="_blank" rel="noopener">http://127.0.0.1:8161/admin/</a></li>
<li>Login: admin</li>
<li>Passwort: admin</li>
<li>Navigate to “Queues”</li>
<li>Add a queue name and click create</li>
<li>Send test message by klicking on “Send to”</li>
</ul>
<h3 id="Listen-port"><a href="#Listen-port" class="headerlink" title="Listen port"></a>Listen port</h3><p>ActiveMQ’s default port is 61616. From another window run netstat and search for port 61616.From a Unix command shell, type:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ netstat -nl | grep 61616</span><br><span class="line">tcp6       0      0 :::61616                :::*                    LISTEN</span><br></pre></td></tr></table></figure></p>
<p>部分示例可以在<a href="https://github.com/hewentian/mq-demo">这里</a>找到。</p>
<h3 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h3><p>ObjectMessage objects depend on Java serialization of marshal/unmarshal object payload. This process is generally considered unsafe as malicious payload can exploit the host system. That’s why starting with versions 5.12.2 and 5.13.0, ActiveMQ enforces users to explicitly whitelist packages that can be exchanged using ObjectMessages.</p>
<p>ActiveMQ从5.12.2、5.13.0开始，如果传送的消息是一个<code>JavaBean</code>就要设置一个传输对象包名的白名单列表，否则会报如下错：</p>
<pre><code>javax.jms.JMSException: Failed to build body from content. Serializable class not available to broker. Reason: java.lang.ClassNotFoundException: Forbidden class java.lang.Integer! This class is not trusted to be serialized as ObjectMessage payload. Please take a look at http://activemq.apache.org/objectmessage.html for more information on how to configure trusted classes.
at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:36)
at org.apache.activemq.command.ActiveMQObjectMessage.getObject(ActiveMQObjectMessage.java:213)
at com.hewentian.activemq.bean.Consumer$1.onMessage(Consumer.java:48)
at org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1404)
at org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:131)
at org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:202)
at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133)
at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48)
at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)
at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)
at java.lang.Thread.run(Thread.java:745)
</code></pre><p>根据提示，我们打开<a href="http://activemq.apache.org/objectmessage.html" target="_blank" rel="noopener">http://activemq.apache.org/objectmessage.html</a>，可以发现解决此报错的详细说明。解决方法有二：<br><strong>注意： 我是用方法二解决的，方法一试了，无效。</strong></p>
<ol>
<li><p>The <code>setTrustedPackages()</code> method allows you to set the list of trusted packages you want to be to unserialize, like</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ActiveMQConnectionFactory factory = <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://localhost:61616"</span>);</span><br><span class="line">factory.setTrustedPackages(<span class="keyword">new</span> ArrayList(Arrays.asList(<span class="string">"org.apache.activemq.test,com.hewentian.activemq.bean"</span>.split(<span class="string">","</span>))));</span><br></pre></td></tr></table></figure>
</li>
<li><p>The <code>setTrustAllPackages()</code> allows you to turn off security check and trust all classes. It’s useful for testing purposes.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ActiveMQConnectionFactory factory = <span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://localhost:61616"</span>);</span><br><span class="line">factory.setTrustAllPackages(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>如果是springBoot工程，你也可以在<code>application.properties</code>作如下设置：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.activemq.packages.trust-all=<span class="keyword">true</span></span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">spring.activemq.packages.trusted=&lt;package1&gt;,&lt;package2&gt;,&lt;package3&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="消息的消费者接收消息可以采用两种方式："><a href="#消息的消费者接收消息可以采用两种方式：" class="headerlink" title="消息的消费者接收消息可以采用两种方式："></a>消息的消费者接收消息可以采用两种方式：</h3><ol>
<li>consumer.receive() 或 consumer.receive(int timeout)；</li>
<li>使用setMessageListener。<br>采用第一种方式，消息的接收者会一直等待下去，直到有消息到达，或者超时。后一种方式会注册一个监听器，当有消息到达的时候，会回调它的onMessage()方法。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/01/23/activemq-note/" data-id="cjym9uqbk00085w3k9a96ssou" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/activemq/">activemq</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-rabbitmq-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/17/rabbitmq-note/" class="article-date">
  <time datetime="2018-01-17T04:06:58.000Z" itemprop="datePublished">2018-01-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/17/rabbitmq-note/">rabbitMQ学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在安装好<code>rabbitMQ</code>后，执行<code>rabbitmq-plugins enable rabbitmq_management</code>命令，开启Web管理插件，这样我们就可以通过浏览器来进行管理了。默认地址为：<br><a href="http://localhost:15672/" target="_blank" rel="noopener">http://localhost:15672/</a><br>并使用默认用户guest登录，密码也为guest。这个guest用户只能在安装rabbitMQ的机器上登录，如果要在其他机器登录，则用guest登录后，再创建其他用户即可，创建的用户要授权，否则用API是无法访问的，有可能会报错。因为新创建的用户默认是没有权限访问<code>/</code>的，可以在WEB上面授权，或者用命令授权。<br>列出用户权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo rabbitmqctl list_users</span><br><span class="line"></span><br><span class="line">Listing users ...</span><br><span class="line">hewentian [administrator]</span><br><span class="line">guest [administrator]</span><br><span class="line"></span><br><span class="line">授权</span><br><span class="line">$ sudo rabbitmqctl set_permissions -p / hewentian <span class="string">'.*'</span> <span class="string">'.*'</span> <span class="string">'.*'</span></span><br></pre></td></tr></table></figure></p>
<p>该命令使用户hewentian具有<code>/</code>这个virtual host中所有资源的配置、写、读权限以便管理其中的资源</p>
<p>其使用也是非常容易入门的：<br>在spring boot项目的application.properties中配置关于rabbitMQ的连接和用户信息<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=rabbitmq-demo</span><br><span class="line"></span><br><span class="line">spring.rabbitmq.host=10.1.32.97</span><br><span class="line">spring.rabbitmq.port=5672</span><br><span class="line">spring.rabbitmq.username=hewentian</span><br><span class="line">spring.rabbitmq.password=12345678</span><br></pre></td></tr></table></figure></p>
<p>创建消息生产者Sender，将消息发送到<code>myqueue</code>这个队列<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.AmqpTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> AmqpTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		String context = <span class="string">"hello "</span> + <span class="keyword">new</span> Date();</span><br><span class="line">		<span class="keyword">this</span>.rabbitTemplate.convertAndSend(<span class="string">"myqueue"</span>, context);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建消息消费者Receiver，对队列<code>myqueue</code>进行监听<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RabbitListener</span>(queues = <span class="string">"myqueue"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@RabbitHandler</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String ctx)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Receiver : "</span> + ctx);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>创建RabbitMQ的配置类RabbitConfig<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Queue <span class="title">helloQueue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">"myqueue"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样一个简单的例子就完成了。更多详细例子，请参考<a href="https://github.com/hewentian/mq-demo">这里</a>。另外，下面这两篇文章，值得我们认真看下：<br><a href="http://www.rabbitmq.com/amqp-0-9-1-quickref.html" target="_blank" rel="noopener">http://www.rabbitmq.com/amqp-0-9-1-quickref.html</a><br><a href="http://www.rabbitmq.com/tutorials/amqp-concepts.html" target="_blank" rel="noopener">http://www.rabbitmq.com/tutorials/amqp-concepts.html</a></p>
<p>The default exchange is a direct exchange with no name (empty string) pre-declared by the broker.</p>
<h4 id="Direct-Exchange"><a href="#Direct-Exchange" class="headerlink" title="Direct Exchange"></a>Direct Exchange</h4><p>Direct exchanges are often used to distribute tasks between multiple workers (instances of the same application) in a round robin manner. When doing so, it is important to understand that, in AMQP 0-9-1, messages are load balanced between consumers and not between queues.</p>
<h4 id="Fanout-Exchange"><a href="#Fanout-Exchange" class="headerlink" title="Fanout Exchange"></a>Fanout Exchange</h4><p>A fanout exchange routes messages to all of the queues that are bound to it and the routing key is ignored. If N queues are bound to a fanout exchange, when a new message is published to that exchange a copy of the message is delivered to all N queues. Fanout exchanges are ideal for the broadcast routing of messages.</p>
<p>Because a fanout exchange delivers a copy of a message to every queue bound to it, its use cases are quite similar:</p>
<ul>
<li>Massively multi-player online (MMO) games can use it for leaderboard updates or other global events</li>
<li>Sport news sites can use fanout exchanges for distributing score updates to mobile clients in near real-time</li>
<li>Distributed systems can broadcast various state and configuration updates</li>
<li>Group chats can distribute messages between participants using a fanout exchange (although AMQP does not have a built-in concept of presence, so XMPP may be a better choice)</li>
</ul>
<h4 id="Topic-Exchange"><a href="#Topic-Exchange" class="headerlink" title="Topic Exchange"></a>Topic Exchange</h4><p>Topic exchanges route messages to one or many queues based on matching between a message routing key and the pattern that was used to bind a queue to an exchange. The topic exchange type is often used to implement various publish/subscribe pattern variations. Topic exchanges are commonly used for the multicast routing of messages.</p>
<p>Topic exchanges have a very broad set of use cases. Whenever a problem involves multiple consumers/applications that selectively choose which type of messages they want to receive, the use of topic exchanges should be considered.</p>
<p>Example uses:</p>
<ul>
<li>Distributing data relevant to specific geographic location, for example, points of sale</li>
<li>Background task processing done by multiple workers, each capable of handling specific set of tasks</li>
<li>Stocks price updates (and updates on other kinds of financial data)</li>
<li>News updates that involve categorization or tagging (for example, only for a particular sport or team)</li>
<li>Orchestration of services of different kinds in the cloud</li>
<li>Distributed architecture/OS-specific software builds or packaging where each builder can handle only one architecture or OS</li>
</ul>
<h4 id="Headers-Exchange"><a href="#Headers-Exchange" class="headerlink" title="Headers Exchange"></a>Headers Exchange</h4><p>A headers exchange is designed for routing on multiple attributes that are more easily expressed as message headers than a routing key. Headers exchanges ignore the routing key attribute. Instead, the attributes used for routing are taken from the headers attribute. A message is considered matching if the value of the header equals the value specified upon binding.</p>
<p>It is possible to bind a queue to a headers exchange using more than one header for matching. In this case, the broker needs one more piece of information from the application developer, namely, should it consider messages with any of the headers matching, or all of them? This is what the “x-match” binding argument is for. When the “x-match” argument is set to “any”, just one matching header value is sufficient. Alternatively, setting “x-match” to “all” mandates that all the values must match.</p>
<p>Headers exchanges can be looked upon as “direct exchanges on steroids”. Because they route based on header values, they can be used as direct exchanges where the routing key does not have to be a string; it could be an integer or a hash (dictionary) for example.</p>
<h4 id="Consumers"><a href="#Consumers" class="headerlink" title="Consumers"></a>Consumers</h4><p>Storing messages in queues is useless unless applications can consume them. In the AMQP 0-9-1 Model, there are two ways for applications to do this:</p>
<ul>
<li>Have messages delivered to them (“push API”)</li>
<li>Fetch messages as needed (“pull API”)</li>
</ul>
<p>With the “push API”, applications have to indicate interest in consuming messages from a particular queue. When they do so, we say that they register a consumer or, simply put, subscribe to a queue. It is possible to have more than one consumer per queue or to register an exclusive consumer (excludes all other consumers from the queue while it is consuming).</p>
<h4 id="Connections"><a href="#Connections" class="headerlink" title="Connections"></a>Connections</h4><p>AMQP connections are typically long-lived. AMQP is an application level protocol that uses TCP for reliable delivery. AMQP connections use authentication and can be protected using TLS (SSL). When an application no longer needs to be connected to an AMQP broker, it should gracefully close the AMQP connection instead of abruptly closing the underlying TCP connection.</p>
<p>未完待续。。。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/01/17/rabbitmq-note/" data-id="cjym9uqci002t5w3kuiviru5c" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rabbitmq/">rabbitmq</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-solr-ikanalyzer" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/08/solr-ikanalyzer/" class="article-date">
  <time datetime="2018-01-08T08:07:17.000Z" itemprop="datePublished">2018-01-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/08/solr-ikanalyzer/">solr配置IKAnalyzer的中文分词</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>配置IKAnalyzer的中文分词，基于<code>solr6.5.0</code>：</p>
<p>1、首先下载IKAnalyzer，这是最新的支持solr 6.5，<br><a href="http://files.cnblogs.com/files/wander1129/ikanalyzer-solr5.zip" target="_blank" rel="noopener">http://files.cnblogs.com/files/wander1129/ikanalyzer-solr5.zip</a></p>
<p>在<a href="https://github.com/hewentian/solr-demo/tree/master/docs">这里</a>也有提供</p>
<p>解压后会有四个文件:<br>ext.dic                        为扩展字典<br>stopword.dic                为停止词字典<br>IKAnalyzer.cfg.xml            为配置文件<br>ik-analyzer-solr5-5.x.jar    为分词jar包</p>
<p>2、将文件夹下的IKAnalyzer.cfg.xml, ext.dic和stopword.dic 三个文件复制到<code>/home/hewentian/ProjectD/solr-6.5.0/server/resources</code>目录下（视个人安装solr，而适当修改）<br>注意: 记得将stopword.dic，ext.dic的编码方式为UTF-8 无BOM的编码方式。 </p>
<p>并修改IKAnalyzer.cfg.xml（一般默认即可）<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd"&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;<span class="name">comment</span>&gt;</span>IK Analyzer 扩展配置<span class="tag">&lt;/<span class="name">comment</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"ext_dict"</span>&gt;</span>ext.dic;<span class="tag">&lt;/<span class="name">entry</span>&gt;</span> </span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"ext_stopwords"</span>&gt;</span>stopword.dic;<span class="tag">&lt;/<span class="name">entry</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>3、在ext.dic 里增加自己的扩展词典，例如，唯品会 聚美优品</p>
<p>4、复制<code>ik-analyzer-solr5-5.x.jar</code>到<code>/home/hewentian/ProjectD/solr-6.5.0/server/solr-webapp/webapp/WEB-INF/lib</code>目录下</p>
<p>5、在<code>/home/hewentian/ProjectD/solr-6.5.0/server/solr/mysqlCore/conf/managed-schema</code>文件的前增加如下配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 我添加的IK分词 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_ik"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span>&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"index"</span> <span class="attr">isMaxWordLength</span>=<span class="string">"false"</span> <span class="attr">class</span>=<span class="string">"org.wltea.analyzer.lucene.IKAnalyzer"</span>/&gt;</span> </span><br><span class="line">	<span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"query"</span> <span class="attr">isMaxWordLength</span>=<span class="string">"true"</span> <span class="attr">class</span>=<span class="string">"org.wltea.analyzer.lucene.IKAnalyzer"</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>重启solr:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/solr-6.5.0/bin</span><br><span class="line">$ ./solr stop -all</span><br><span class="line">$ ./solr start</span><br></pre></td></tr></table></figure></p>
<p>在浏览器中打开：<br><a href="http://localhost:8983/solr/#/mysqlCore/analysis" target="_blank" rel="noopener">http://localhost:8983/solr/#/mysqlCore/analysis</a></p>
<p>在Field Value (Index)中输入：中华人民共和国<br>在Analyse Fieldname / FieldType:选择 text_ik</p>
<p>点[Analyse Values]即可看到分词</p>
<p>至此，配置完成。</p>
<h3 id="下面说说配置solr默认的中文分词："><a href="#下面说说配置solr默认的中文分词：" class="headerlink" title="下面说说配置solr默认的中文分词："></a>下面说说配置solr默认的中文分词：</h3><p>1.首先将需要的<code>lucene-analyzers-smartcn-6.5.0.jar</code>复制到<code>WEB-INF/lib/</code>目录下<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/solr-6.5.0</span><br><span class="line">$ cp contrib/analysis-extras/lucene-libs/lucene-analyzers-smartcn-6.5.0.jar server/solr-webapp/webapp/WEB-INF/lib/</span><br></pre></td></tr></table></figure></p>
<p>2、为mysqlCore添加对中文分词的支持，在<code>/home/hewentian/ProjectD/solr-6.5.0/server/solr/mysqlCore/conf/managed-schema</code>文件的前增加如下配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_smartcn"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"index"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"org.apache.lucene.analysis.cn.smart.HMMChineseTokenizerFactory"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"query"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"org.apache.lucene.analysis.cn.smart.HMMChineseTokenizerFactory"</span>/&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>重启solr测试即可。可以与IK分词的结果作对比。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/01/08/solr-ikanalyzer/" data-id="cjym9uqcn00395w3ktiilnq5i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solr/">solr</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-solr-pinyin" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/08/solr-pinyin/" class="article-date">
  <time datetime="2018-01-08T06:52:08.000Z" itemprop="datePublished">2018-01-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/08/solr-pinyin/">solr配置拼音检索</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>配置拼音检索，基于<code>solr6.5.0</code>：</p>
<p>1、前期准备，需要用到pinyin4j-2.5.0.jar、pinyinAnalyzer4.3.1.jar这两个jar包,下载地址：<br><a href="http://files.cnblogs.com/files/wander1129/pinyin.zip" target="_blank" rel="noopener">http://files.cnblogs.com/files/wander1129/pinyin.zip</a></p>
<p>在<a href="https://github.com/hewentian/solr-demo/tree/master/docs">这里</a>也有提供pinyin.zip</p>
<p>解压后会有2个文件:<br>pinyin4j-2.5.0.jar<br>pinyinAnalyzer4.3.1.jar</p>
<p>2、将上面的两个文件复制到<code>/home/hewentian/ProjectD/solr-6.5.0/server/solr-webapp/webapp/WEB-INF/lib</code>目录下，还有执行如下命令，<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/solr-6.5.0</span><br><span class="line">$ cp contrib/analysis-extras/lucene-libs/lucene-analyzers-smartcn-6.5.0.jar server/solr-webapp/webapp/WEB-INF/lib/</span><br></pre></td></tr></table></figure></p>
<p>将需要的<code>lucene-analyzers-smartcn-6.5.0.jar</code>复制到<code>WEB-INF/lib/</code>目录下</p>
<p>3、在<code>/home/hewentian/ProjectD/solr-6.5.0/server/solr/mysqlCore/conf/managed-schema</code>文件的前增加如下配置<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">fieldType</span> <span class="attr">name</span>=<span class="string">"text_pinyin"</span> <span class="attr">class</span>=<span class="string">"solr.TextField"</span> <span class="attr">positionIncrementGap</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"index"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"org.apache.lucene.analysis.cn.smart.HMMChineseTokenizerFactory"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"com.shentong.search.analyzers.PinyinTransformTokenFilterFactory"</span> <span class="attr">minTermLenght</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"com.shentong.search.analyzers.PinyinNGramTokenFilterFactory"</span> <span class="attr">minGram</span>=<span class="string">"1"</span> <span class="attr">maxGram</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">analyzer</span> <span class="attr">type</span>=<span class="string">"query"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tokenizer</span> <span class="attr">class</span>=<span class="string">"org.apache.lucene.analysis.cn.smart.HMMChineseTokenizerFactory"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"com.shentong.search.analyzers.PinyinTransformTokenFilterFactory"</span> <span class="attr">minTermLenght</span>=<span class="string">"2"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"com.shentong.search.analyzers.PinyinNGramTokenFilterFactory"</span> <span class="attr">minGram</span>=<span class="string">"1"</span> <span class="attr">maxGram</span>=<span class="string">"20"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">analyzer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">fieldType</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>重启solr:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/solr-6.5.0/bin</span><br><span class="line">$ ./solr stop -all</span><br><span class="line">$ ./solr start</span><br></pre></td></tr></table></figure></p>
<p>4、在浏览器中打开：<br><a href="http://localhost:8983/solr/#/mysqlCore/analysis" target="_blank" rel="noopener">http://localhost:8983/solr/#/mysqlCore/analysis</a></p>
<p>在Field Value (Index)中输入：中国<br>在Analyse Fieldname / FieldType:选择 text_pinyin</p>
<p>点[Analyse Values]即可看到分词</p>
<p>至此，配置完成。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2018/01/08/solr-pinyin/" data-id="cjym9uqcq003i5w3kzah5rnyg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solr/">solr</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-install-jdk" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/08/install-jdk/" class="article-date">
  <time datetime="2017-12-08T03:44:06.000Z" itemprop="datePublished">2017-12-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/java/">java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/08/install-jdk/">安装 JDK</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="下面分别说说在Windows和Linux平台下面安装JDK"><a href="#下面分别说说在Windows和Linux平台下面安装JDK" class="headerlink" title="下面分别说说在Windows和Linux平台下面安装JDK"></a>下面分别说说在<code>Windows</code>和<code>Linux</code>平台下面安装<code>JDK</code></h2><h3 id="1-在Windows下面安装JDK"><a href="#1-在Windows下面安装JDK" class="headerlink" title="1.在Windows下面安装JDK"></a>1.在<code>Windows</code>下面安装<code>JDK</code></h3><pre><code>JDK环境变量配置的步骤如下：
1. 我的电脑 -&gt; 属性 -&gt; 高级 -&gt; 环境变量；
2. 配置用户变量：
    a.新建 JAVA_HOME
    C:\Program Files\Java\jdk1.8.0_101 （JDK的安装路径，务必替换成你自已的）
    b.新建 PATH（如果系统本身已有，则修改，加入下面的代码）
    %JAVA_HOME%\bin;%JAVA_HOME%\jre\bin
    c.新建 CLASSPATH
    .;%JAVA_HOME%\lib;%JAVA_HOME%\lib\tools.jar
3. 测试环境变量配置是否成功：
    开始 -&gt; 运行 -&gt; cmd
    键盘敲入: java
出现相应的命令，而不是出错信息，即表示配置成功！
</code></pre><p>环境变量配置的理解：</p>
<ol>
<li>PATH：作用是指定命令搜索路径，在命令行下面执行命令如：<code>javac</code>编译<code>java</code>程序时，它会到<code>PATH</code>变量所指定的路径中查找看是否能找到相应的命令程序。我们需要把<code>jdk</code>安装目录下的<code>bin</code>目录增加到现有的<code>PATH</code>变量中，<code>bin</code>目录中包含经常要用到的可执行文件如<code>javac/java/javadoc</code>等待，设置好<code>PATH</code>变量后，就可以在任何目录下执行<code>javac/java</code>等工具了；</li>
<li>CLASSPATH：作用是指定类搜索路径，要使用已经编写好的类，前提当然是能够找到它们了，<code>JVM</code>就是通过<code>CLASSPTH</code>来寻找类的。我们需要把<code>jdk</code>安装目录下的<code>lib子</code>目录中的<code>dt.jar</code>和<code>tools.jar</code>设置到<code>CLASSPATH</code>中，当然，当前目录“<code>.</code>”也必须加入到该变量中；</li>
<li>JAVA_HOME：它指向<code>jdk</code>的安装目录，<code>Eclipse/NetBeans/Tomcat</code>等软件就是通过搜索<code>JAVA_HOME</code>变量来找到并使用安装好的<code>jdk</code>。</li>
</ol>
<h3 id="2-在Linux下面安装JDK"><a href="#2-在Linux下面安装JDK" class="headerlink" title="2.在Linux下面安装JDK"></a>2.在<code>Linux</code>下面安装<code>JDK</code></h3><p>第一步：下载<code>jdk-8u102-linux-x64.tar.gz</code><br>直接在<code>ORACLE</code>的官网中下载就可以:<br><a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="noopener">http://www.oracle.com/technetwork/java/javase/downloads/index.html</a><br>PS：要注意系统版本的选择，32位 还是 64位，执行如下命令即可知道答案<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">Linux hewentian-Lenovo-IdeaPad-Y470 4.10.0-28-generic <span class="comment">#32~16.04.2-Ubuntu SMP Thu Jul 20 10:19:48 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></span><br></pre></td></tr></table></figure></p>
<p>第二步：解压安装<br>接着就是解压<code>tar.gz</code>的文件了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/Downloads</span><br><span class="line">$ tar -xzvf jdk-8u102-linux-x64.tar.gz</span><br></pre></td></tr></table></figure></p>
<p>解压后会得到<code>jdk1.8.0_102</code>文件夹，接着就是将解压出来的文件夹移动到<code>/usr/local</code>的目录下<br>在这之前当然需要你拥有root的权限<code>su root</code>(对于ubuntu)再输入root账户的密码，做好这些准备之后，我们就可以把jdk的文件移动到我们想要的位置了。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ su root</span><br><span class="line">Password: </span><br><span class="line">$ mv jdk1.8.0_102 /usr/<span class="built_in">local</span></span><br></pre></td></tr></table></figure></p>
<p>第三步：修改环境变量，若<code>PATH</code>已存在，则用冒号作间隔，将jdk的bin目录地址加上，这样java的环境变量将配置成功了，配置完成如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile </span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk1.8.0_102</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$JAVA_HOME</span>/jre</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/lib:<span class="variable">$JRE_HOME</span>/lib:<span class="variable">$CLASSPATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$JRE_HOME</span>/bin:<span class="variable">$JAVA_HOME</span>:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></p>
<p>记得保存 后执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure></p>
<p>第四步：但这样默认使用的JDK可能还不是我们刚才安装的，因为ubuntu可能还会有默认的jdk，如openjdk；所以，为了使默认使用的是我们安装的jdk，还需执行如下命令：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo update-alternatives --install /usr/bin/java java /usr/<span class="built_in">local</span>/jdk1.8.0_102/bin/java 300  </span><br><span class="line">$ sudo update-alternatives --install /usr/bin/javac javac /usr/<span class="built_in">local</span>/jdk1.8.0_102/bin/javac 300    </span><br><span class="line"></span><br><span class="line">$ sudo update-alternatives --config java</span><br><span class="line">$ sudo update-alternatives --config javac</span><br><span class="line">这时如果有多个jdk的话（比如openJDK和SUN JDK），就会出来一个列表，当前默认的会在列表前面有一个<span class="string">"`*`"</span>号，</span><br><span class="line">这时我们就要选择我们刚装的SUN JDK的java的那个序号，输入这个序号，回车就行了。</span><br></pre></td></tr></table></figure></p>
<p>第五步：成功执行命令后，我们安装的JDK就是系统默认的了，执行如下命令，就可以成功看到JDK的相关信息了如：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ java -version　</span><br><span class="line">java version <span class="string">"1.8.0_102"</span></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_102-b14)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.102-b14, mixed mode)</span><br></pre></td></tr></table></figure></p>
<p>第六步：在ubuntu下面，可能root用户无法使用JDK，这样的话，执行下面的配置：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ vi /root/.bashrc</span><br><span class="line"></span><br><span class="line">在文件中加上(注意，下面的变量参数有<span class="variable">$&#123;&#125;</span>的，与上面的不同)</span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk1.8.0_102</span><br><span class="line"><span class="built_in">export</span> JRE_HOME=<span class="variable">$&#123;JAVA_HOME&#125;</span>/jre</span><br><span class="line"><span class="built_in">export</span> CLASSPATH=.:<span class="variable">$&#123;JAVA_HOME&#125;</span>/lib:<span class="variable">$&#123;JRE_HOME&#125;</span>/lib:<span class="variable">$CLASSPATH</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$&#123;JAVA_HOME&#125;</span>/bin:<span class="variable">$&#123;JRE_HOME&#125;</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line">最后：</span><br><span class="line"><span class="built_in">source</span> /root/.bashrc</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2017/12/08/install-jdk/" data-id="cjym9uqc000195w3kj9kpb6eq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/jdk/">jdk</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-mysql-note" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/07/mysql-note/" class="article-date">
  <time datetime="2017-12-07T02:26:13.000Z" itemprop="datePublished">2017-12-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/db/">db</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/07/mysql-note/">mysql 学习笔记</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="mysql-查询重复数据"><a href="#mysql-查询重复数据" class="headerlink" title="mysql 查询重复数据"></a>mysql 查询重复数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> user_name, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> c <span class="keyword">FROM</span> user_table <span class="keyword">GROUP</span> <span class="keyword">BY</span> user_name <span class="keyword">HAVING</span> c &gt; <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>当查询几个列的组合的时候，可以这样<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(first_name, <span class="string">'_'</span>, last_name) <span class="keyword">AS</span> user_name, <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> c </span><br><span class="line"><span class="keyword">FROM</span> user_table </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_name </span><br><span class="line"><span class="keyword">HAVING</span> c &gt; <span class="number">1</span>;</span><br></pre></td></tr></table></figure></p>
<p>当使用<code>CONCAT(str1,str2,...)</code>函数的时候，只要有一个参数为<code>null</code>，则整个结果为<code>null</code>，而有时候这不是我们所想要的结果，这时候，我们可以使用<code>IFNULL(expr1,expr2)</code>函数来做一个转换，当<code>expr1</code>为<code>null</code>的时候，表达式的结果为<code>expr2</code>，否则为<code>expr1</code>，示例如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT CONCAT('Tim', ' ', 'Ho') FROM DUAL;	# Tim Ho</span><br><span class="line">SELECT IFNULL(null, 'expr2') FROM DUAL;		# expr2</span><br><span class="line">SELECT IFNULL('expr1', 'expr2') FROM DUAL;	# expr1</span><br></pre></td></tr></table></figure></p>
<h3 id="mysql-添加唯一约束"><a href="#mysql-添加唯一约束" class="headerlink" title="mysql 添加唯一约束"></a>mysql 添加唯一约束</h3><p>表<code>t_user</code>结构如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Field        Type          Collation        Null    Key     Default            Extra           Privileges                       <span class="keyword">Comment</span>               </span><br><span class="line"><span class="comment">-----------  ------------  ---------------  ------  ------  -----------------  --------------  -------------------------------  ----------------------</span></span><br><span class="line"><span class="keyword">id</span>           <span class="built_in">int</span>(<span class="number">11</span>)       (<span class="literal">NULL</span>)           <span class="keyword">NO</span>      PRI     (<span class="literal">NULL</span>)             auto_increment  <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span>  用户<span class="keyword">ID</span>              </span><br><span class="line">login_name   <span class="built_in">varchar</span>(<span class="number">100</span>)  utf8_general_ci  <span class="keyword">NO</span>              (<span class="literal">NULL</span>)                             <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span>  登录名             </span><br><span class="line">passwd       <span class="built_in">varchar</span>(<span class="number">100</span>)  utf8_general_ci  <span class="keyword">NO</span>              (<span class="literal">NULL</span>)                             <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span>  登录密码          </span><br><span class="line">nick_name    <span class="built_in">varchar</span>(<span class="number">100</span>)  utf8_general_ci  YES             (<span class="literal">NULL</span>)                             <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span>  别名                </span><br><span class="line">gender       tinyint(<span class="number">4</span>)    (<span class="literal">NULL</span>)           YES             <span class="number">1</span>                                  <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span>  性别：<span class="number">1.</span>男；<span class="number">2.</span>女</span><br><span class="line">phone        <span class="built_in">varchar</span>(<span class="number">20</span>)   utf8_general_ci  YES             (<span class="literal">NULL</span>)                             <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span>  手机号码          </span><br><span class="line">address      <span class="built_in">varchar</span>(<span class="number">255</span>)  utf8_general_ci  YES             (<span class="literal">NULL</span>)                             <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span>  地址                </span><br><span class="line">create_time  <span class="keyword">timestamp</span>     (<span class="literal">NULL</span>)           YES             <span class="keyword">CURRENT_TIMESTAMP</span>                  <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span>  创建时间          </span><br><span class="line">update_time  <span class="keyword">timestamp</span>     (<span class="literal">NULL</span>)           YES             (<span class="literal">NULL</span>)                             <span class="keyword">select</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">references</span>  修改时间</span><br></pre></td></tr></table></figure></p>
<p>给 login_name 和 phone 添加联合唯一约束<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> t_user <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> (login_name, phone);</span><br></pre></td></tr></table></figure></p>
<p>你也可以在创建唯一约束的时候，给唯一约束起名<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> t_user <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uk_login_name_phone`</span> (login_name, phone);</span><br></pre></td></tr></table></figure></p>
<p>查看结果：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t_user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_user`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'用户ID'</span>,</span><br><span class="line">  <span class="string">`login_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'登录名'</span>,</span><br><span class="line">  <span class="string">`passwd`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'登录密码'</span>,</span><br><span class="line">  <span class="string">`nick_name`</span> <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'别名'</span>,</span><br><span class="line">  <span class="string">`gender`</span> tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="string">'1'</span> <span class="keyword">COMMENT</span> <span class="string">'性别：1.男；2.女'</span>,</span><br><span class="line">  <span class="string">`phone`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'手机号码'</span>,</span><br><span class="line">  <span class="string">`address`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'地址'</span>,</span><br><span class="line">  <span class="string">`create_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'创建时间'</span>,</span><br><span class="line">  <span class="string">`update_time`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'修改时间'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`uk_login_name_phone`</span> (<span class="string">`login_name`</span>,<span class="string">`phone`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br></pre></td></tr></table></figure></p>
<p>删除唯一约束:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> t_user <span class="keyword">DROP</span> <span class="keyword">INDEX</span> uk_login_name_phone;</span><br></pre></td></tr></table></figure></p>
<hr>
<h3 id="MySQL中GROUP-CONCAT函数"><a href="#MySQL中GROUP-CONCAT函数" class="headerlink" title="MySQL中GROUP_CONCAT函数"></a>MySQL中GROUP_CONCAT函数</h3><p>参考：<a href="http://hchmsguo.iteye.com/blog/555543" target="_blank" rel="noopener">http://hchmsguo.iteye.com/blog/555543</a><br>完整的语法如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GROUP_CONCAT([DISTINCT] 要连接的字段 [Order BY ASC/DESC 排序字段] [Separator '分隔符'])</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>基本查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> aa;  </span><br><span class="line"></span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">| id| name |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">|1 | 10|</span><br><span class="line">|1 | 20|</span><br><span class="line">|1 | 20|</span><br><span class="line">|2 | 20|</span><br><span class="line">|3 | 200 |</span><br><span class="line">|3 | 500 |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">6 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>以id分组，把name字段的值打印在一行，逗号分隔(默认)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">group_concat</span>(<span class="keyword">name</span>) <span class="keyword">from</span> aa <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>;  </span><br><span class="line"></span><br><span class="line">+<span class="comment">------+--------------------+</span></span><br><span class="line">| id| group_concat(name) |</span><br><span class="line">+<span class="comment">------+--------------------+</span></span><br><span class="line">|1 | 10,20,20|</span><br><span class="line">|2 | 20 |</span><br><span class="line">|3 | 200,500|</span><br><span class="line">+<span class="comment">------+--------------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>以id分组，把name字段的值打印在一行，分号分隔</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">group_concat</span>(<span class="keyword">name</span> separator <span class="string">';'</span>) <span class="keyword">from</span> aa <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>;  </span><br><span class="line"></span><br><span class="line">+<span class="comment">------+----------------------------------+</span></span><br><span class="line">| id| group_concat(name separator ';') |</span><br><span class="line">+<span class="comment">------+----------------------------------+</span></span><br><span class="line">|1 | 10;20;20 |</span><br><span class="line">|2 | 20|</span><br><span class="line">|3 | 200;500 |</span><br><span class="line">+<span class="comment">------+----------------------------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>以id分组，把去冗余的name字段的值打印在一行，逗号分隔</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">group_concat</span>(<span class="keyword">distinct</span> <span class="keyword">name</span>) <span class="keyword">from</span> aa <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>;  </span><br><span class="line"></span><br><span class="line">+<span class="comment">------+-----------------------------+</span></span><br><span class="line">| id| group_concat(distinct name) |</span><br><span class="line">+<span class="comment">------+-----------------------------+</span></span><br><span class="line">|1 | 10,20|</span><br><span class="line">|2 | 20 |</span><br><span class="line">|3 | 200,500 |</span><br><span class="line">+<span class="comment">------+-----------------------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>以id分组，把name字段的值打印在一行，逗号分隔，以name排倒序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">group_concat</span>(<span class="keyword">name</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">name</span> <span class="keyword">desc</span>) <span class="keyword">from</span> aa <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>;  </span><br><span class="line"></span><br><span class="line">+<span class="comment">------+---------------------------------------+</span></span><br><span class="line">| id| group_concat(name order by name desc) |</span><br><span class="line">+<span class="comment">------+---------------------------------------+</span></span><br><span class="line">|1 | 20,20,10 |</span><br><span class="line">|2 | 20|</span><br><span class="line">|3 | 500,200|</span><br><span class="line">+<span class="comment">------+---------------------------------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="GROUP-CONCAT使用及报错分析"><a href="#GROUP-CONCAT使用及报错分析" class="headerlink" title="GROUP_CONCAT使用及报错分析"></a>GROUP_CONCAT使用及报错分析</h3><p>函数GROUP_CONCAT，但在使用时，结果报了如下错误。</p>
<pre><code>ERROR 1260 (HY000): Row 17 was cut by GROUP_CONCAT()
</code></pre><p>原因：GROUP_CONCAT截断了结果，GROUP_CONCAT有个最大长度的限制，超过最大长度就会被截断掉。可以用下面命令查看其内存限制。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> @@global.group_concat_max_len;</span><br><span class="line"></span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| @@global.group_concat_max_len |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">|                      1024     |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br></pre></td></tr></table></figure></p>
<p>1024这就是一般MySQL系统默认的最大长度，解决限制方法有二：<br>方法一：在MySQL配置文件中加上<br>group_concat_max_len = 102400 #你要的最大长度</p>
<p>方法二：可以简单一点，执行语句：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> group_concat_max_len=<span class="number">102400</span>;</span><br></pre></td></tr></table></figure></p>
<p>我是用方法一解决的</p>
<h3 id="对连接要注意的事项"><a href="#对连接要注意的事项" class="headerlink" title="对连接要注意的事项"></a>对连接要注意的事项</h3><p>当用多个值连接起来产生一个MD5值、或其他用于确定唯一性的时候，几个值之间一定要加分隔符，否则不同记录可能会产生一样的MD5值。如下表：</p>
<pre><code>NAME    AGE    FAMLY_NUM
张三    51    5
李四    5    15
</code></pre><p>如果用AGE， FAMLY_NUM来产生一个MD5值来唯一确定这一条记录，在它们之间一定要加分隔符，否则连接结果都是515</p>
<h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><p>在MYSQL中用<code>数据库管理员</code>用户创建了一个db，其他MYSQL用户是暂时看不到的，除非得到<code>数据库管理员</code>用户的授权<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> bfg_db <span class="keyword">COLLATE</span> = <span class="string">'utf8_general_ci'</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> = <span class="string">'utf8'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">GRANT</span> ALL <span class="keyword">ON</span> bfg_db.* <span class="keyword">TO</span> <span class="string">'bfg_user'</span>@<span class="string">'%'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'iE1zNB?A91*YbQ9hK'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">GRANT</span> ALL <span class="keyword">ON</span> bfg_db.* <span class="keyword">TO</span> <span class="string">'bfg_user'</span>@<span class="string">'localhost'</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'iE1zNB?A91*YbQ9hK'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure></p>
<h3 id="mysql添加、删除主键"><a href="#mysql添加、删除主键" class="headerlink" title="mysql添加、删除主键"></a>mysql添加、删除主键</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">添加自增长的主键id</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tb <span class="keyword">ADD</span> PRIMARY <span class="keyword">KEY</span>(<span class="keyword">id</span>);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tb <span class="keyword">CHANGE</span> <span class="keyword">id</span> <span class="keyword">id</span> <span class="built_in">INT</span>(<span class="number">10</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">删除自增长的主键id，先删除自增长，再删除主键</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tb <span class="keyword">CHANGE</span> <span class="keyword">id</span> <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">10</span>); //删除自增长</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> tb <span class="keyword">DROP</span> PRIMARY <span class="keyword">KEY</span>; //删除主建</span><br></pre></td></tr></table></figure>
<h3 id="mysql查找删除重复数据并只保留一条"><a href="#mysql查找删除重复数据并只保留一条" class="headerlink" title="mysql查找删除重复数据并只保留一条"></a>mysql查找删除重复数据并只保留一条</h3><p>有表数据如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t_user;</span><br><span class="line">+<span class="comment">------+-------+------+</span></span><br><span class="line">| id   | name  | age  |</span><br><span class="line">+<span class="comment">------+-------+------+</span></span><br><span class="line">|    1 | zhang |   21 |</span><br><span class="line">|    2 | li    |   22 |</span><br><span class="line">|    3 | zhang |   23 |</span><br><span class="line">+<span class="comment">------+-------+------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>从上面可知，name字段有两条相同的记录zhang，我们要删除重复记录,保存id最小的一条<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> </span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">	t_user </span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">	<span class="keyword">name</span> <span class="keyword">IN</span> ( <span class="keyword">SELECT</span> t1.name <span class="keyword">FROM</span> ( <span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">FROM</span> t_user <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">name</span> <span class="keyword">HAVING</span> <span class="keyword">COUNT</span>( * ) &gt; <span class="number">1</span> ) t1 ) </span><br><span class="line">	<span class="keyword">AND</span> </span><br><span class="line">	<span class="keyword">id</span> <span class="keyword">NOT</span> <span class="keyword">IN</span> (<span class="keyword">SELECT</span> t2.id <span class="keyword">FROM</span> ( <span class="keyword">SELECT</span> <span class="keyword">min</span>( <span class="keyword">id</span> ) <span class="keyword">id</span> <span class="keyword">FROM</span> t_user <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">name</span> <span class="keyword">HAVING</span> <span class="keyword">count</span>( * ) &gt; <span class="number">1</span> ) t2 );</span><br><span class="line">	</span><br><span class="line">然后再执行查询语句：</span><br><span class="line">mysql&gt; select * from t_user;</span><br><span class="line">+<span class="comment">------+-------+------+</span></span><br><span class="line">| id   | name  | age  |</span><br><span class="line">+<span class="comment">------+-------+------+</span></span><br><span class="line">|    1 | zhang |   21 |</span><br><span class="line">|    2 | li    |   22 |</span><br><span class="line">+<span class="comment">------+-------+------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>可知，id为3的记录已经被删掉了。</p>
<h3 id="char-varchar-nvarchar区别"><a href="#char-varchar-nvarchar区别" class="headerlink" title="char varchar nvarchar区别"></a>char varchar nvarchar区别</h3><p>参考：<a href="https://www.cnblogs.com/yelaiju/archive/2010/05/29/1746826.html" target="_blank" rel="noopener">https://www.cnblogs.com/yelaiju/archive/2010/05/29/1746826.html</a><br>Unicode字符集就是为了解决字符集的不兼容的问题而产生的，它所有的字符都用两个字节表示，即英文字符也是用两个字节表示</p>
<p>varchar(n)<br>长度为 n 个字节的可变长度且非 Unicode 的字符数据。n 必须是一个介于 1 和 8,000 之间的数值。存储大小为输入数据的字节的实际长度，而不是 n 个字节。</p>
<p>nvarchar(n)<br>包含 n 个字符的可变长度 Unicode 字符数据。n 的值必须介于 1 与 4,000 之间。字节的存储大小是所输入字符个数的两倍。</p>
<p>两字段分别有字段值：我和coffee<br>那么varchar字段占2×2+6=10个字节的存储空间，而nvarchar字段占8×2=16个字节的存储空间。</p>
<p>一般来说，如果含有中文字符，用nchar/nvarchar，如果纯英文和数字，用char/varchar</p>
<p>联机帮助上的：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>长度</th>
<th>使用说明</th>
<th>长度说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>char(n)</td>
<td>定长</td>
<td>索引效率高 程序里面使用trim去除多余的空白</td>
<td>n 必须是一个介于 1 和 8,000 之间的数值,存储大小为 n 个字节</td>
</tr>
<tr>
<td>varchar(n)</td>
<td>变长</td>
<td>效率没char高 灵活</td>
<td>n 必须是一个介于 1 和 8,000 之间的数值。存储大小为输入数据的字节的实际长度，而不是 n 个字节</td>
</tr>
<tr>
<td>text(n)</td>
<td>变长</td>
<td>非Unicode数据</td>
<td>不用指定长度</td>
</tr>
<tr>
<td>nchar(n)</td>
<td>定长</td>
<td>处理unicode数据类型(所有的字符使用两个字节表示)</td>
<td>n 的值必须介于 1 与 4,000 之间。存储大小为 n 字节的两倍</td>
</tr>
<tr>
<td>nvarchar(n)</td>
<td>变长</td>
<td>处理unicode数据类型(所有的字符使用两个字节表示)</td>
<td>n 的值必须介于 1 与 4,000 之间。字节的存储大小是所输入字符个数的两倍。所输入的数据字符长度可以为零</td>
</tr>
<tr>
<td>ntext(n)</td>
<td>变长</td>
<td>处理unicode数据类型(所有的字符使用两个字节表示)</td>
<td>不用指定长度</td>
</tr>
</tbody>
</table>
<p>很多开发者进行数据库设计的时候往往并没有太多的考虑char， varchar类型，有的是根本就没注意，因为存储价格变得越来越便宜了，忘记了最开始的一些基本设计理论和原则，这点让我想到了现在的年轻人，大手一挥一把人民币就从他手里溜走了，其实我想不管是做人也好，做开发也好，细节的把握直接决定很多东西。当然还有一部分人是根本就没弄清楚他们的区别，也就随便选一个。在这里我想对他们做个简单的分析，当然如果有不对的地方希望大家指教。<br>1、CHAR。CHAR存储定长数据很方便，CHAR字段上的索引效率级高，比如定义char(10)，那么不论你存储的数据是否达到了10个字节，都要占去10个字节的空间,不足的自动用空格填充，所以在读取的时候可能要多次用到trim（）。</p>
<p>2、VARCHAR。存储变长数据，但存储效率没有CHAR高。如果一个字段可能的值是不固定长度的，我们只知道它不可能超过10个字符，把它定义为 VARCHAR(10)是最合算的。VARCHAR类型的实际长度是它的值的实际长度+1。为什么“+1”呢？这一个字节用于保存实际使用了多大的长度。从空间上考虑，用varchar合适；从效率上考虑，用char合适，关键是根据实际情况找到权衡点。</p>
<p>3、TEXT。text存储可变长度的非Unicode数据，最大长度为2^31-1(2,147,483,647)个字符。</p>
<p>4、NCHAR、NVARCHAR、NTEXT。这三种从名字上看比前面三种多了个“N”。它表示存储的是Unicode数据类型的字符。我们知道字符中，英文字符只需要一个字节存储就足够了，但汉字众多，需要两个字节存储，英文与汉字同时存在时容易造成混乱，Unicode字符集就是为了解决字符集这种不兼容的问题而产生的，它所有的字符都用两个字节表示，即英文字符也是用两个字节表示。nchar、nvarchar的长度是在1到4000之间。和char、varchar比较起来，nchar、nvarchar则最多存储4000个字符，不论是英文还是汉字；而char、varchar最多能存储8000个英文，4000个汉字。可以看出使用nchar、nvarchar数据类型时不用担心输入的字符是英文还是汉字，较为方便，但在存储英文时数量上有些损失。</p>
<p>所以一般来说，如果含有中文字符，用nchar/nvarchar，如果纯英文和数字，用char/varchar</p>
<p>它们的区别概括成：<br>CHAR，NCHAR 定长，速度快，占空间大，需处理<br>VARCHAR，NVARCHAR，TEXT 不定长，空间小，速度慢，无需处理<br>NCHAR、NVARCHAR、NTEXT处理Unicode码</p>
<h3 id="mysql-修改字段长度"><a href="#mysql-修改字段长度" class="headerlink" title="mysql 修改字段长度"></a>mysql 修改字段长度</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> [表名] <span class="keyword">modify</span> <span class="keyword">column</span> [字段名] [类型];</span><br><span class="line"></span><br><span class="line">示例: sys_user表里的user_name字段，由原来长度是10个字符，修改改成40个字符</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sys_user <span class="keyword">modify</span> <span class="keyword">column</span> user_name <span class="built_in">varchar</span>(<span class="number">40</span>);</span><br></pre></td></tr></table></figure>
<h3 id="mysql-增加列（字段）"><a href="#mysql-增加列（字段）" class="headerlink" title="mysql 增加列（字段）"></a>mysql 增加列（字段）</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> [表名] <span class="keyword">add</span> [列名] [列类型] [其他属性，如默认值];</span><br><span class="line"></span><br><span class="line">示例: sys_user表增加一个地址列，长度为200个字符，默认值为null</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> sys_user <span class="keyword">add</span> address <span class="built_in">varchar</span>(<span class="number">200</span>) <span class="keyword">default</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>
<h3 id="mysql-按字段分组，取最小生日记录"><a href="#mysql-按字段分组，取最小生日记录" class="headerlink" title="mysql 按字段分组，取最小生日记录"></a>mysql 按字段分组，取最小生日记录</h3><p>有用户表如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sql&gt; select * from user;</span><br><span class="line"></span><br><span class="line">id	name	birthday</span><br><span class="line">1	a	2018-01-25 09:30:05</span><br><span class="line">2	a	2018-01-25 09:30:14</span><br><span class="line">3	a	2018-01-25 09:30:10</span><br><span class="line">4	b	2018-01-25 09:30:29</span><br><span class="line">5	b	2018-01-25 09:30:24</span><br></pre></td></tr></table></figure></p>
<p><strong>要求：</strong>以name分组，取出生日最小的记录，即id为2、4的记录<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sql&gt; select * from (select * from user order by birthday desc) t group by t.name;</span><br><span class="line"></span><br><span class="line">id	name	birthday</span><br><span class="line">2	a	2018-01-25 09:30:14</span><br><span class="line">4	b	2018-01-25 09:30:29</span><br></pre></td></tr></table></figure></p>
<h3 id="mysql-仅保留-1000-条记录而删除其他记录"><a href="#mysql-仅保留-1000-条记录而删除其他记录" class="headerlink" title="mysql 仅保留 1000 条记录而删除其他记录"></a>mysql 仅保留 1000 条记录而删除其他记录</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">求取总记录数</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> tb_name;</span><br><span class="line"></span><br><span class="line">删除部分记录</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tb_name <span class="keyword">limit</span> 总记录数<span class="number">-1000</span></span><br><span class="line"></span><br><span class="line">例如，比如一个表有 <span class="number">10000</span> 条记录，现想保留 <span class="number">1000</span> 条数据</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> tb_name <span class="keyword">limit</span> <span class="number">9000</span></span><br></pre></td></tr></table></figure>
<h3 id="MySQL数据库备份和还原常用的命令"><a href="#MySQL数据库备份和还原常用的命令" class="headerlink" title="MySQL数据库备份和还原常用的命令"></a>MySQL数据库备份和还原常用的命令</h3><h4 id="一、备份命令"><a href="#一、备份命令" class="headerlink" title="一、备份命令"></a>一、备份命令</h4><p>如果只需要导出表的结构,可以使用mysqldump的<code>-d</code>选项<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">1、备份MySQL数据库的命令，备份指定的整个库</span><br><span class="line">mysqldump -hhostname -uusername -ppassword databasename &gt; ~/backupfile.sql</span><br><span class="line"></span><br><span class="line">2、备份MySQL数据库为带删除表的格式，能够让该备份覆盖已有数据库而不需要手动删除原有数据库</span><br><span class="line">mysqldump <span class="comment">--add-drop-table -hhostname -uusername -ppassword databasename &gt; ~/backupfile.sql</span></span><br><span class="line"></span><br><span class="line">3、直接将MySQL数据库压缩备份</span><br><span class="line">mysqldump -hhostname -uusername -ppassword databasename | gzip &gt; ~/backupfile.sql.gz</span><br><span class="line"></span><br><span class="line">4、备份MySQL数据库某个(些)表</span><br><span class="line">mysqldump -hhostname -uusername -ppassword databasename specific_table1 [specific_table2] &gt; ~/backupfile.sql</span><br><span class="line"></span><br><span class="line">5、同时备份多个MySQL数据库</span><br><span class="line">mysqldump -hhostname -uusername -ppassword <span class="comment">--databases databasename1 databasename2 databasename3 &gt; ~/multibackupfile.sql</span></span><br><span class="line"></span><br><span class="line">6、仅仅备份数据库结构</span><br><span class="line">mysqldump -hhostname -uusername -ppassword -d <span class="comment">--databases databasename1 databasename2 databasename3 &gt; ~/structurebackupfile.sql</span></span><br><span class="line"></span><br><span class="line">7、备份服务器上所有数据库</span><br><span class="line">mysqldump -hhostname -uusername -ppassword <span class="comment">--all-databases &gt; ~/allbackupfile.sql</span></span><br><span class="line"></span><br><span class="line">8、备份MySQL数据库某个表中指定条件的数据</span><br><span class="line">mysqldump -hhostname -uusername -ppassword databasename specific_table1 <span class="comment">--where='age &gt; 10' &gt; ~/backupfile.sql</span></span><br></pre></td></tr></table></figure></p>
<h4 id="二、还原命令"><a href="#二、还原命令" class="headerlink" title="二、还原命令"></a>二、还原命令</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1、还原MySQL数据库的命令</span><br><span class="line">mysql -hhostname -uusername -ppassword databasename &lt; ~/backupfile.sql</span><br><span class="line"></span><br><span class="line">2、还原压缩的MySQL数据库</span><br><span class="line">gunzip &lt; ~/backupfile.sql.gz | mysql -uusername -ppassword databasename</span><br><span class="line"></span><br><span class="line">3、将数据库转移到新服务器</span><br><span class="line">mysqldump -uusername -ppassword databasename | mysql -host=*.*.*.* -C databasename</span><br></pre></td></tr></table></figure>
<h3 id="select-into"><a href="#select-into" class="headerlink" title="select into"></a>select into</h3><p>除此之外，你还可以使用<code>select into</code>命令来导出数据，它与mysqldump的区别是：</p>
<ol>
<li>mysqldump: 导出的文本包括了数据库的结构和记录；</li>
<li>select into: 导出的文本只有记录，并且，一般要数据库的管理员帐号，例如root才能执行；</li>
</ol>
<p>select into 有两种使用方式：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">方式一：</span><br><span class="line">mysql&gt; select * from t_user into outfile 't_user.txt';</span><br><span class="line">Query OK, 2 rows affected (0.16 sec)</span><br><span class="line"></span><br><span class="line">方式二：</span><br><span class="line">mysql&gt; select * into outfile 't_user.txt' from t_user;</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>导出的数据一般在数据库的安装目录下，你也可以使用<code>find / -name t_user.txt</code>来查找到</p>
<h3 id="ERROR-3-HY000-Error-writing-file-‘-tmp-MYeaZGpS’-Errcode-28-No-space-left-on-device"><a href="#ERROR-3-HY000-Error-writing-file-‘-tmp-MYeaZGpS’-Errcode-28-No-space-left-on-device" class="headerlink" title="ERROR 3 (HY000): Error writing file ‘/tmp/MYeaZGpS’ (Errcode: 28 - No space left on device)"></a>ERROR 3 (HY000): Error writing file ‘/tmp/MYeaZGpS’ (Errcode: 28 - No space left on device)</h3><p>根据提示，是说mysql中/tmp使用的磁盘空间不足。<br>在MYSQL命令行下执行：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like 'tmpdir';</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">| tmpdir        | /tmp  |</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>可以看到MYSQL的tmpdir是使用/tmp这个临时目录的，使用<code>df -h</code>看下/tmp的空间，确实不足。我们修改tmpdir所指定的目录，我们在空间比较大的分区上面建一个目录。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /opt/data</span><br><span class="line">$ mkdir mysqltmp</span><br><span class="line">$ chmod a+w mysqltmp</span><br></pre></td></tr></table></figure></p>
<p>然后修改my.cnf配置文件在其中修改tmpdir<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ whereis my.cnf</span><br><span class="line">$ <span class="built_in">cd</span> &#123;my.cnf所在的目录&#125;</span><br><span class="line">$ vi my.cnf</span><br><span class="line"><span class="comment"># 修改的内容如下</span></span><br><span class="line">tmpdir = /opt/data/mysqltmp</span><br></pre></td></tr></table></figure></p>
<p>重启mysql<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/mysqld restart	<span class="comment"># 注意linux系统，命令可能不同</span></span><br></pre></td></tr></table></figure></p>
<p>在MYSQL命令行中查看下是否生效<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like 'tmpdir';</span><br><span class="line">+<span class="comment">---------------+--------------------+</span></span><br><span class="line">| Variable_name | Value              |</span><br><span class="line">+<span class="comment">---------------+--------------------+</span></span><br><span class="line">| tmpdir        | /opt/data/mysqltmp |</span><br><span class="line">+<span class="comment">---------------+--------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>问题解决。</p>
<p>读一致性：ORACLE有一个表，有1000W条记录。在9：00的时候A用户对表进行查询，查询需10分钟才能完成，表没索引，FULL SCAN，表中某条记录的值为100。在9：05分的时候B对表进行了UPDATE操作，将记录的值修改为200。那么在9:10的时候，A获致到的是100还是200？结果是100.因为这是读一致性的问题，在A查的时候，它看到的是整个表在那一刻的快照的数据，返回的是那一刻的结果。不过，它有可能会抛出 snapshot too old 这个异常。</p>
<h3 id="mysql-修改表名"><a href="#mysql-修改表名" class="headerlink" title="mysql 修改表名"></a>mysql 修改表名</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name RENAME TO new_table_name;</span><br></pre></td></tr></table></figure>
<h3 id="MySQL-百万级分页优化-Mysql千万级快速分页"><a href="#MySQL-百万级分页优化-Mysql千万级快速分页" class="headerlink" title="MySQL 百万级分页优化(Mysql千万级快速分页)"></a>MySQL 百万级分页优化(Mysql千万级快速分页)</h3><p>转自：<a href="http://www.jb51.net/article/31868.htm" target="_blank" rel="noopener">http://www.jb51.net/article/31868.htm</a></p>
<p>一般刚开始学SQL的时候，会这样写，代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM table ORDER BY id LIMIT 1000, 10;</span><br></pre></td></tr></table></figure></p>
<p>但在数据达到百万级的时候，这样写会慢死，代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM table ORDER BY id LIMIT 1000000, 10;</span><br></pre></td></tr></table></figure></p>
<p>也许耗费几十秒 </p>
<p>网上很多优化的方法是这样的，代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM table WHERE id &gt;= (SELECT id FROM table LIMIT 1000000, 1) LIMIT 10;</span><br></pre></td></tr></table></figure></p>
<p>是的，速度提升到0.x秒了，看样子还行了<br>可是，还不是完美的！ </p>
<p>以下这句才是完美的！代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM table WHERE id BETWEEN 1000000 AND 1000010;</span><br></pre></td></tr></table></figure></p>
<p>比上面那句，还要再快5至10倍 </p>
<p>另外，如果需要查询 id 不是连续的一段，最佳的方法就是先找出 id ，然后用 in 查询，代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM table WHERE id IN(10000, 100000, 1000000...);</span><br></pre></td></tr></table></figure></p>
<p>再分享一点<br>查询字段一较长字符串的时候，表设计时要为该字段多加一个字段,如，存储网址的字段，查询的时候，不要直接查询字符串，效率低下，应该查询该字串的crc32或md5 </p>
<h3 id="mysql-查询一个字符串字段-最长的一条记录"><a href="#mysql-查询一个字符串字段-最长的一条记录" class="headerlink" title="mysql 查询一个字符串字段 最长的一条记录"></a>mysql 查询一个字符串字段 最长的一条记录</h3><p>参考：<a href="http://stackoverflow.com/questions/2357620/maxlengthfield-in-mysql" target="_blank" rel="noopener">http://stackoverflow.com/questions/2357620/maxlengthfield-in-mysql</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select name, length( name )</span><br><span class="line">from my_table</span><br><span class="line">where length( name ) = ( select max( length( name ) ) from my_table );</span><br></pre></td></tr></table></figure></p>
<h3 id="skip-grant-tables-参数的使用"><a href="#skip-grant-tables-参数的使用" class="headerlink" title="skip-grant-tables 参数的使用"></a>skip-grant-tables 参数的使用</h3><p>这是个非常有用的mysql启动参数</p>
<p>在my.cnf文件中增加一行：</p>
<pre><code>[mysqld]
skip-grant-tables
</code></pre><p>或者以命令行参数启动mysql：</p>
<pre><code>/usr/bin/mysqld_safe --skip-grant-tables &amp;
</code></pre><p>登陆mysql修改管理员密码：</p>
<pre><code>use mysql;
update user set password=password(&apos;root&apos;) where user=&apos;root&apos;;
flush privileges;
exit;
</code></pre><p>重启mysql</p>
<h3 id="VARCHAR类型的说明"><a href="#VARCHAR类型的说明" class="headerlink" title="VARCHAR类型的说明"></a>VARCHAR类型的说明</h3><p>在官方手册中，VARCHAR类型最大支持65535，单位是字节，但实际上。在创建表的时候VARCHAR(N)中的N，指的是字符的长度。但是，如果表的字符集不同，能支持的最大长度也不同。</p>
<ol>
<li>表的CHARSET=latin1时，能使用VARCHAR(65532)；</li>
<li>表的CHARSET=GBK时，能使用VARCHAR(32767)；</li>
<li>表的CHARSET=UTF8，能使用VARCHAR(21845)；</li>
<li>如果表的SQL_MODE为非严格模式，则表的CHARSET=latin1时，或者能使用VARCHAR(65535)成功创建表，但是可能会有warning。warning可能是数据将那列自动转换为TEXT类型了；</li>
<li>还有一个需要注意的地方是，65535长度是指表中所有VARCHAR列的长度总和。如果列的长度总和超出这个限制，依然无法创建表。</li>
</ol>
<h3 id="CHAR类型的说明"><a href="#CHAR类型的说明" class="headerlink" title="CHAR类型的说明"></a>CHAR类型的说明</h3><p>CHAR(N)中的N指的是字符，对于多字节字符编码的CHAR数据类型，在InnoDB存储引擎中，会将其视为变长类型。对于未能占满长度的字符，还是填充<code>0X20</code>，也即是空格。</p>
<p>在多字节字符集的情况下，CHAR和VARCHAR的实际行存储基本是没有区别的。</p>
<h3 id="NOT-NULL约束的说明"><a href="#NOT-NULL约束的说明" class="headerlink" title="NOT NULL约束的说明"></a>NOT NULL约束的说明</h3><p>如果我们向NOT NULL的字段插入一下NULL值，MySQL数据库会将其更改为0再进行插入。我们可以通过设置SQL_MODE来严格审核输入参数。</p>
<h3 id="强制使用索引"><a href="#强制使用索引" class="headerlink" title="强制使用索引"></a>强制使用索引</h3><p>在查询的过程中可以使用<code>FORCE INDEX</code>来强制查询优化器使用指定的索引，例如表<code>t_user</code>有索引<code>idx_name</code>，则我们可以这样查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t_user FORCE INDEX(idx_name) WHERE name=&apos;Tim&apos; and age=22;</span><br></pre></td></tr></table></figure></p>
<h3 id="索引提示"><a href="#索引提示" class="headerlink" title="索引提示"></a>索引提示</h3><p>在查询的过程中可以使用<code>USE INDEX</code>来显式地告诉查询优化器使用哪个索引，例如表<code>t_user</code>有索引<code>idx_name</code>，则我们可以这样查询：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM t_user USE INDEX(idx_name) WHERE name=&apos;Tim&apos; and age=22;</span><br></pre></td></tr></table></figure></p>
<p>主要在以下2种情况下要使用索引提示：</p>
<ol>
<li>MYSQL数据库的优化器错误地选择了某个索引，导致SQL语句运行得很慢；</li>
<li>某SQL语句可以选择的索引非常多，优化器选择执行计划时间的开销大于SQL语句本身。</li>
</ol>
<p><code>USE INDEX</code>只是告诉优化器可以选择该索引，但实际上优化器可能还是会再根据自已的判断进行选择，除非使用<code>FORCE INDEX</code>。</p>
<p>对数据库执行了一个删除操作，实际上并不会删除索引中的数据，相反还会在对应的DELETED表中插入记录，因此随着应用程序的运行，索引会变得非常大。即使索引中的有些数据已经被删除，查询也不会选择这类记录。InnoDb存储引擎，可以在必要时手动将已经删除的记录在索引中删除，命令是 OPTIMIZE TABLE。它还会对Cardinality进行统计，因此可以关闭它的统计。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL innodb_optimize_fulltext_only=1;</span><br><span class="line">mysql&gt; OPTIMIZE TABLE table_name;</span><br></pre></td></tr></table></figure></p>
<h3 id="锁问题"><a href="#锁问题" class="headerlink" title="锁问题"></a>锁问题</h3><p>锁问题有三个：</p>
<ol>
<li><p>脏读：首先了解一下脏数据，脏数据是指事务对缓冲池中行记录的修改，并且还没有被提交。如果读到了脏数据，即一个事务可以读到另外一个事务中未提交的数据，这显然违反了数据库的隔离性。而对脏页的读取，是非常正常的。脏页是因为数据库实例内存和磁盘的异步造成的，这并不影响数据的一致性，因为内存中的数据最终是要刷新回磁盘的。</p>
</li>
<li><p>不可重复读：在同一个事务中多次读取同一个表，在多次读取之间，还有另外一个事务对该表进行了DML，从而导致多次读取到的数据可能不一致。与脏读的区别是：脏读读取到的是未提交的数据，而不可重复读读到的是已经提交的数据。这违反了数据库事务的一致性。</p>
</li>
<li><p>丢失更新：就是一个事务的更新操作，会被另一个事务的更新操作所覆盖，从而导致数据的不一致。可以将事务的处理模式变成串行的，这样来避免。在更新数据的时候，特别是敏感数据的时候，一定要先加一个排他X锁，这样也方便对帐户余额进行先检查，再更新。而不是仅仅学会了简单的SELECT、UPDATE操作就开始处理数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT cash FROM account WHERE user=&apos;user_name&apos; FOR UPDATE;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="事务的特性"><a href="#事务的特性" class="headerlink" title="事务的特性"></a>事务的特性</h3><p>对于InnoDB存储引擎而言，它默认的事务隔离级别为READ REPEATABLE，完全遵循和满足事务的ACID特性。</p>
<p>TRUNCATE TABLE 属于DDL，它虽然和对整张表执行DELETE操作产生的效果差不多，但是它是不能ROLLBACK的。</p>
<h3 id="事务的隔离级别"><a href="#事务的隔离级别" class="headerlink" title="事务的隔离级别"></a>事务的隔离级别</h3><p>SQL标准定义了4个隔离级别：<br>READ UNCOMMITTED<br>READ COMMITTED<br>REPEATABLE READ<br>SERIALIZABLE</p>
<p>可以在数据库启动的时候设置它的默认隔离级别：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">transaction-isolation=READ-COMMITTED</span><br></pre></td></tr></table></figure></p>
<p>查看当前会话的事务隔离级别：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT @@tx_isolation;</span><br></pre></td></tr></table></figure></p>
<h3 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h3><p>InnoDB存储引擎提供了对XA事务的支持，并通过XA事务来支持分布式事务的实现。分布式事务指的是允许多个独立的事务资源参与到一个全局的事务中。事务资源通常是关系型数据库系统，但也可以是其他类型的资源。全局事务要求在其中的所有参与事务要么都提交，要么都ROLLBACK，这对于事务原有的ACID要求又有了提高。另外，在使用分布式事务时，InnoDB存储引擎的事务隔离级别必须设置为SERIALIZABLE。<br>XA事务允许不同数据库之间的分布式事务，如一台服务器是MySQL数据库，另一台是Oracle数据库，只要参与在全局事务中的每个节点都支持XA事务。分布式事务可能在银行系统的转帐中比较常见。可以通过变量查看数据库是否启用了XA事务支持（默认为ON）：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &apos;innodb_support_xa&apos;;</span><br></pre></td></tr></table></figure></p>
<p>MySQL数据库是自动提交的。当用户显式的使用命令<code>START TRANSACTION</code>或<code>BEGIN</code>来开启一个事务时，MySQL会自动地执行<code>SET AUTOCOMMIT=0</code>命令，并在<code>COMMIT</code>或<code>ROLLBACK</code>结束一个事务后，再执行<code>SET AUTOCOMMIT=1</code>。</p>
<p>对长事务的处理，是将长事务分解为多个小事务来分批处理。在应用程序中，最好是将事务的START TRANSACTION、COMMIT、ROLLBACK操作交给程序端来控制，而不是在存储过程中。</p>
<h3 id="备份与恢复"><a href="#备份与恢复" class="headerlink" title="备份与恢复"></a>备份与恢复</h3><p>Hot Backup 热备： 在数据库运行中直接备份，对运行中的数据库操作没有任何的影响；<br>Cold Backup 冷备： 在数据库停机状态下进行备份，一般备份数据库的物理文件；<br>Warm Backup 温备：也是在数据库运行中进行备份，但是会对当前的数据库操作有所影响，例如它会加一个全局读锁以保证备份数据的一致性。</p>
<p>对于mysqldump备份工具来说，可以通过添加<code>--single-transaction</code>选项获得InnoDB存储引擎的一致性备份，此时的备份是在一个执行时间很长的事务中完成的。请务必加上此选项。</p>
<p>mysqldump不能导出视图。免费好用的开源热备份工具有XtraBackup。</p>
<h3 id="不登录MYSQL来执行查询"><a href="#不登录MYSQL来执行查询" class="headerlink" title="不登录MYSQL来执行查询"></a>不登录MYSQL来执行查询</h3><p>可以在操作系统命令行下通过<code>-e</code>参数实现，例如查询test库下的表t_user：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># mysql -h192.168.1.100 -uscoot -ptiger test -e &quot;select * from t_user&quot;</span><br><span class="line"></span><br><span class="line">+----+-------+------+</span><br><span class="line">| id | name  | age  |</span><br><span class="line">+----+-------+------+</span><br><span class="line">|  1 | zhang |   21 |</span><br><span class="line">|  2 | zhang |   23 |</span><br><span class="line">|  4 | zhang |   21 |</span><br><span class="line">|  5 | zhang |   21 |</span><br><span class="line">+----+-------+------+</span><br></pre></td></tr></table></figure></p>
<p>说明：</p>
<pre><code>-e, --execute=name  Execute command and quit. (Disables --force and history file.)
</code></pre><h3 id="对MySQL数据库性能的测试工具"><a href="#对MySQL数据库性能的测试工具" class="headerlink" title="对MySQL数据库性能的测试工具"></a>对MySQL数据库性能的测试工具</h3><p>这里有2款比较好的工具：sysbench和mysql-tpcc</p>
<p>主要测试：<br>CPU性能<br>磁盘IO性能<br>调度程序性能<br>内存分配及传输速度<br>POSIX线程性能<br>数据库OLTP基准测试</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2017/12/07/mysql-note/" data-id="cjym9uqcf002m5w3kms2c48fg" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/mysql/">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-zookeeper-install-cluster" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/06/zookeeper-install-cluster/" class="article-date">
  <time datetime="2017-12-06T08:33:35.000Z" itemprop="datePublished">2017-12-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/bigdata/">bigdata</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/06/zookeeper-install-cluster/">zookeeper 集群版安装方法</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="计划在一台Ubuntu-Linux服务器上部署3台zookeeper服务器，分别为server1-server2-server3"><a href="#计划在一台Ubuntu-Linux服务器上部署3台zookeeper服务器，分别为server1-server2-server3" class="headerlink" title="计划在一台Ubuntu Linux服务器上部署3台zookeeper服务器，分别为server1, server2, server3"></a>计划在一台<code>Ubuntu Linux</code>服务器上部署3台<code>zookeeper</code>服务器，分别为<code>server1</code>, <code>server2</code>, <code>server3</code></h3><p>因为三台<code>zookeeper</code>服务器的配置都差不多，所以我们先设置好一台<code>server1</code>的配置，再将其复制成<code>server2</code>, <code>server3</code>并修改其中的配置即可。</p>
<h3 id="1-建目录，如下："><a href="#1-建目录，如下：" class="headerlink" title="1.建目录，如下："></a>1.建目录，如下：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p /home/hewentian/ProjectD/zookeeperCluster/server1</span><br><span class="line">$ mkdir -p /home/hewentian/ProjectD/zookeeperCluster/server1/data</span><br></pre></td></tr></table></figure>
<h3 id="2-将zookeeper-3-4-6-tar-gz放到-home-hewentian-ProjectD-zookeeperCluster-server1目录下，并执行如下脚本解压"><a href="#2-将zookeeper-3-4-6-tar-gz放到-home-hewentian-ProjectD-zookeeperCluster-server1目录下，并执行如下脚本解压" class="headerlink" title="2.将zookeeper-3.4.6.tar.gz放到/home/hewentian/ProjectD/zookeeperCluster/server1目录下，并执行如下脚本解压"></a>2.将<code>zookeeper-3.4.6.tar.gz</code>放到<code>/home/hewentian/ProjectD/zookeeperCluster/server1</code>目录下，并执行如下脚本解压</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server1</span><br><span class="line">$ tar xzvf zookeeper-3.4.6.tar.gz</span><br></pre></td></tr></table></figure>
<h3 id="3-解压后得到zookeeper-3-4-6文件夹，进入conf目录"><a href="#3-解压后得到zookeeper-3-4-6文件夹，进入conf目录" class="headerlink" title="3.解压后得到zookeeper-3.4.6文件夹，进入conf目录"></a>3.解压后得到<code>zookeeper-3.4.6</code>文件夹，进入<code>conf</code>目录</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> zookeeper-3.4.6/conf/</span><br></pre></td></tr></table></figure>
<h3 id="4-执行如下命令，新建一个配置文件zoo-cfg"><a href="#4-执行如下命令，新建一个配置文件zoo-cfg" class="headerlink" title="4.执行如下命令，新建一个配置文件zoo.cfg"></a>4.执行如下命令，新建一个配置文件zoo.cfg</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp zoo_sample.cfg zoo.cfg</span><br></pre></td></tr></table></figure>
<h3 id="5-修改zoo-cfg并在其中修改如下内容："><a href="#5-修改zoo-cfg并在其中修改如下内容：" class="headerlink" title="5.修改zoo.cfg并在其中修改如下内容："></a>5.修改zoo.cfg并在其中修改如下内容：</h3><pre><code>tickTime=2000
initLimit=10
syncLimit=5
dataDir=/home/hewentian/ProjectD/zookeeperCluster/server1/data # 这里必须为绝对路径，否则有可能无法启动
clientPort=2181                 # 这台服务器的端口为2181（即默认值），当部署为真集群的时候各个节点的端口都是2181
server.1=127.0.0.1:2888:3888    # 当部署成真集群的时候：
server.2=127.0.0.1:2889:3889    # server.1、server.2和server.3后面的IP要修改成各个节点的真实IP或者域名
server.3=127.0.0.1:2890:3890    # 并且server.2、server.3后面的两个端口要和server.1的是一样的，都是2888:3888
</code></pre><h3 id="6-在-home-hewentian-ProjectD-zookeeperCluster-server1-data目录下建myid文件并在其中输入1，只输入1，代表server-1"><a href="#6-在-home-hewentian-ProjectD-zookeeperCluster-server1-data目录下建myid文件并在其中输入1，只输入1，代表server-1" class="headerlink" title="6.在/home/hewentian/ProjectD/zookeeperCluster/server1/data目录下建myid文件并在其中输入1，只输入1，代表server.1"></a>6.在<code>/home/hewentian/ProjectD/zookeeperCluster/server1/data</code>目录下建<code>myid</code>文件并在其中输入1，只输入1，代表server.1</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server1/data</span><br><span class="line">$ vi myid</span><br></pre></td></tr></table></figure>
<p>这样第一台服务器已经配置完毕。</p>
<h3 id="7-接下来我们将server1复制为server2-server3"><a href="#7-接下来我们将server1复制为server2-server3" class="headerlink" title="7.接下来我们将server1复制为server2, server3"></a>7.接下来我们将<code>server1</code>复制为<code>server2</code>, <code>server3</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster</span><br><span class="line">$ cp -r server1 server2</span><br><span class="line">$ cp -r server1 server3</span><br></pre></td></tr></table></figure>
<h3 id="8-将server2-data目录下的myid的内容修改为2"><a href="#8-将server2-data目录下的myid的内容修改为2" class="headerlink" title="8.将server2/data目录下的myid的内容修改为2"></a>8.将<code>server2/data</code>目录下的<code>myid</code>的内容修改为2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server2/data</span><br><span class="line">$ vi myid</span><br></pre></td></tr></table></figure>
<p>同理，将将<code>server3/data</code>目录下的<code>myid</code>的内容修改为3<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server3/data</span><br><span class="line">$ vi myid</span><br></pre></td></tr></table></figure></p>
<h3 id="9-修改server2的配置文件"><a href="#9-修改server2的配置文件" class="headerlink" title="9.修改server2的配置文件"></a>9.修改<code>server2</code>的配置文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server2/zookeeper-3.4.6/conf/</span><br><span class="line">$ vi zoo.cfg</span><br></pre></td></tr></table></figure>
<p>仅修改两处地方即可，要修改的地方如下：</p>
<pre><code>dataDir=/home/hewentian/ProjectD/zookeeperCluster/server2/data  # 这里是数据保存的位置
clientPort=2182                                                 # 这台服务器的端口为2182
</code></pre><p>同理，修改<code>server3</code>的配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server3/zookeeper-3.4.6/conf/</span><br><span class="line">$ vi zoo.cfg</span><br></pre></td></tr></table></figure></p>
<p>仅修改两处地方即可，要修改的地方如下：</p>
<pre><code>dataDir=/home/hewentian/ProjectD/zookeeperCluster/server3/data  # 这里是数据保存的位置
clientPort=2183                                                 # 这台服务器的端口为2183
</code></pre><h3 id="10-到目前为此，我们已经将3台zookeeper服务器都配置好了。接下来，我们要将他们都启动"><a href="#10-到目前为此，我们已经将3台zookeeper服务器都配置好了。接下来，我们要将他们都启动" class="headerlink" title="10.到目前为此，我们已经将3台zookeeper服务器都配置好了。接下来，我们要将他们都启动"></a>10.到目前为此，我们已经将3台<code>zookeeper</code>服务器都配置好了。接下来，我们要将他们都启动</h3><p>启动server1<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server1/zookeeper-3.4.6/bin/</span><br><span class="line">$ ./zkServer.sh start</span><br></pre></td></tr></table></figure></p>
<p>启动server2<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server2/zookeeper-3.4.6/bin/</span><br><span class="line">$ ./zkServer.sh start</span><br></pre></td></tr></table></figure></p>
<p>启动server3<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server3/zookeeper-3.4.6/bin/</span><br><span class="line">$ ./zkServer.sh start</span><br></pre></td></tr></table></figure></p>
<h3 id="11-当三台服务器都启动好了，我们分别连到server1、server2、server3："><a href="#11-当三台服务器都启动好了，我们分别连到server1、server2、server3：" class="headerlink" title="11.当三台服务器都启动好了，我们分别连到server1、server2、server3："></a>11.当三台服务器都启动好了，我们分别连到server1、server2、server3：</h3><p>连接到server1<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server1/zookeeper-3.4.6/bin/</span><br><span class="line">$ ./zkCli.sh -server 127.0.0.1:2181</span><br></pre></td></tr></table></figure></p>
<p>连接到server2<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server2/zookeeper-3.4.6/bin/</span><br><span class="line">$ ./zkCli.sh -server 127.0.0.1:2182</span><br></pre></td></tr></table></figure></p>
<p>连接到server1<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server3/zookeeper-3.4.6/bin/</span><br><span class="line">$ ./zkCli.sh -server 127.0.0.1:2183</span><br></pre></td></tr></table></figure></p>
<p>这样你在<code>server1</code>中所作的修改，都会同步到<code>server2</code>, <code>server3</code>。<br>例如你在server1中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ create /zk_test_cluster my_data_cluster</span><br></pre></td></tr></table></figure></p>
<p>你在server2, server3的客户端用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ls /</span><br></pre></td></tr></table></figure></p>
<p>都会看到节点zk_test_cluster</p>
<h3 id="12-查看运行状态"><a href="#12-查看运行状态" class="headerlink" title="12. 查看运行状态"></a>12. 查看运行状态</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server2/zookeeper-3.4.6/</span><br><span class="line">$ ./bin/zkServer.sh status</span><br><span class="line">JMX enabled by default</span><br><span class="line">Using config: /home/hewentian/ProjectD/zookeeperCluster/server2/zookeeper-3.4.6/bin/../conf/zoo.cfg</span><br><span class="line">Mode: leader</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> /home/hewentian/ProjectD/zookeeperCluster/server3/zookeeper-3.4.6/</span><br><span class="line">$ ./bin/zkServer.sh status</span><br><span class="line">JMX enabled by default</span><br><span class="line">Using config: /home/hewentian/ProjectD/zookeeperCluster/server3/zookeeper-3.4.6/bin/../conf/zoo.cfg</span><br><span class="line">Mode: follower</span><br></pre></td></tr></table></figure>
<p>可以看到server2是leader，其他两台是follower。</p>
<p>集群部署结束。</p>
<h3 id="zookeeper三种角式"><a href="#zookeeper三种角式" class="headerlink" title="zookeeper三种角式"></a>zookeeper三种角式</h3><p>leader：负责进行投票的发起和决议，更新系统状态；<br>follower：负责接受客户端的请求并向客户端返回结果，在选主过程中参与投票；<br>observer：接受客户端的连接，将写请求转发给leader，但不参与投票，只同步leader的状态，observer的目的是为了扩展系统，提高读取速度。follower和observer统称为leaner。<br>client：客户端，请求发起方。</p>
<p>配置observer比较简单，只要在<code>zoo.cfg</code>中将要配置成为observer的机器加个后缀即可，如下：</p>
<pre><code>server.3=127.0.0.1:2890:3890:observer
</code></pre><h3 id="zookeeper的节点类型"><a href="#zookeeper的节点类型" class="headerlink" title="zookeeper的节点类型"></a>zookeeper的节点类型</h3><p>zookeeper有4种节点类型：</p>
<ol>
<li>PERSISTENT                持久化节点</li>
<li>PERSISTENT_SEQUENTIAL     顺序自动编号持久化节点，这种节点会根据当前已存在的节点数自动加 1</li>
<li>EPHEMERAL                 临时节点， 客户端session超时这类节点就会被自动删除</li>
<li>EPHEMERAL_SEQUENTIAL      临时自动编号节点</li>
</ol>
<p><strong> 注意：EPHEMERAL类型的节点不能有子节点 </strong></p>
<h3 id="参数说明："><a href="#参数说明：" class="headerlink" title="参数说明："></a>参数说明：</h3><ol>
<li>tickTime：zookeeper中使用的基本时间单位，毫秒值；</li>
<li>initLimit：由于zookeeper集群中包含多台server，其中一台为leader，其余的为follower。initLimit参数配置初始化连接时，follower和leader之间的最长心跳时间，此时该参数设置为5，说明时间限制为5倍tickTime, 即：5 * 2000 = 10000ms = 10s；</li>
<li>syncLimit：该参数配置leader和follower之间发送消息，请求和应答的最大时间长度。此时该参数设置为2，说明时间限制为2倍tickTime，即4000ms；</li>
<li>dataDir: 数据存放目录，可以是任意目录；</li>
<li>dataLogDir: log目录，同样可以是任意目录。如果没有设置该参数，将使用和dataDir相同的设置；</li>
<li>clientPort: 监听client连接的端口号；</li>
<li>server.X=A:B:C：其中X是一个数字，表示这是第几号server。A是该server所在的IP地址；B配置该server和集群中的leader交换消息所使用的端口；C配置选举leader时所使用的端口。由于配置的是伪集群模式，所以各个server的B，C参数必须不同。</li>
</ol>
<h3 id="zookeeper能帮我们做什么"><a href="#zookeeper能帮我们做什么" class="headerlink" title="zookeeper能帮我们做什么"></a>zookeeper能帮我们做什么</h3><ol>
<li>Hadoop使用zookeeper的事件处理确保整个集群只有一个NameNode存储配置信息等；</li>
<li>HBase使用zookeeper的事件处理确保整个集群只有一个HMaster，察觉HRegionServer联机和宕机、存储访问控制列表等。</li>
</ol>
<h3 id="一些要注意的"><a href="#一些要注意的" class="headerlink" title="一些要注意的"></a>一些要注意的</h3><ol>
<li>注册的Watcher消息只会通知一次；</li>
<li>节点需要奇数个的原因有二：（1）容错和偶数是一样的，所以没必要多台；（2）防止脑裂；</li>
<li>zookeeper两种模式：恢复模式（选主）和广播模式（Zab原子广播更新数据）；</li>
<li>zookeeper的4个特点：最终一致性、可靠性、原子性、顺序性（因为增删改都发给Leader）；</li>
<li>zookeeper的数据存放在内存中，但是会定期flush到磁盘dataDir的目录中。</li>
</ol>
<p>通过java api使用zookeeper的例子可以参见这里： <a href="https://github.com/hewentian/hadoop-demo/blob/master/src/main/java/com/hewentian/hadoop/utils/ZookeeperUtil.java">ZookeeperUtil.java</a>、<a href="https://github.com/hewentian/hadoop-demo/tree/master/src/main/java/com/hewentian/hadoop/zookeeper">zookeeper实现分布式锁、rmi高可用</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://github.com/hewentian/2017/12/06/zookeeper-install-cluster/" data-id="cjym9uqcs003o5w3km4ynxko3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/zookeeper/">zookeeper</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/bigdata/">bigdata</a><span class="category-list-count">25</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/container/">container</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/db/">db</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/other/">other</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web-server/">web server</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">October 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">September 2018</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">4</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/26/docker-note/">docker 学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/06/10/nginx-note/">nginx 学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/01/20/hbase-cluster/">hbase 集群的搭建</a>
          </li>
        
          <li>
            <a href="/2019/01/10/hive-note/">hive 学习笔记</a>
          </li>
        
          <li>
            <a href="/2019/01/01/hadoop-cluster-ha/">hadoop 集群的搭建HA</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">link</h3>
    <div class="widget">
      <li><a href="https://github.com/hewentian" title="Tim Ho's Blog">我的github</a></li>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Tim Ho<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives/" class="mobile-nav-link">Archives</a>
  
    <a href="/categories/" class="mobile-nav-link">Categories</a>
  
    <a href="/tags/" class="mobile-nav-link">Tags</a>
  
    <a href="/about/" class="mobile-nav-link">About</a>
  
</nav>
    

<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script> -->
<script src="//code.jquery.com/jquery-2.2.4.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>